# ===============================================
# USSD Service - PRODUCTION Configuration
# ===============================================
# WARNING: This configuration is for PRODUCTION use only
# Ensure all secrets are stored in secure vaults (AWS Secrets Manager, Azure Key Vault, etc.)
# Never commit actual credentials to version control

server:
  port: 8004
  servlet:
    context-path: /
  tomcat:
    threads:
      max: 400
      min-spare: 20
    max-connections: 16384
    accept-count: 200
  compression:
    enabled: true
    mime-types: text/html,text/xml,text/plain,text/css,application/json
    min-response-size: 1024

spring:
  application:
    name: ussd-service

  # Production Eureka Configuration
  cloud:
    openfeign:
      client:
        config:
          default:
            connectTimeout: 5000
            readTimeout: 30000
            loggerLevel: basic  # Reduced logging for production
          auth-service:
            url: ${AUTH_SERVICE_URL:http://auth-service:8080}
          user-service:
            url: ${USER_SERVICE_URL:http://user-service:8082}
          notification-service:
            url: ${NOTIFICATION_SERVICE_URL:http://notification-service:8086}

  # Production Database (PostgreSQL)
  datasource:
    url: jdbc:postgresql://${DB_HOST:localhost}:${DB_PORT:5432}/${DB_NAME:epb_db}
    username: ${DB_USERNAME:ussd_user}
    password: ${DB_PASSWORD:CHANGE_ME_IN_PRODUCTION}
    driver-class-name: org.postgresql.Driver
    hikari:
      maximum-pool-size: 40
      minimum-idle: 10
      idle-timeout: 300000
      max-lifetime: 1800000
      connection-timeout: 30000
      leak-detection-threshold: 60000

  jpa:
    hibernate:
      ddl-auto: validate  # Never use create-drop in production
    show-sql: false
    properties:
      hibernate:
        format_sql: false
        dialect: org.hibernate.dialect.PostgreSQLDialect
        jdbc:
          batch_size: 20
        order_inserts: true
        order_updates: true

  # Production Redis Configuration
  redis:
    host: ${REDIS_HOST:localhost}
    port: ${REDIS_PORT:6379}
    password: ${REDIS_PASSWORD:}
    database: 0
    timeout: 3000ms
    lettuce:
      pool:
        max-active: 40
        max-idle: 20
        min-idle: 5
        max-wait: 5000ms
      shutdown-timeout: 100ms

  cache:
    type: redis
    redis:
      time-to-live: 300000  # 5 minutes
      cache-null-values: false
      key-prefix: "ussd:"
    cache-names:
      - sessions
      - users
      - opportunities
      - districts

  # Production Jackson Configuration
  jackson:
    serialization:
      write-dates-as-timestamps: false
      indent-output: false  # Disable pretty printing
    time-zone: Africa/Kampala
    date-format: yyyy-MM-dd HH:mm:ss
    default-property-inclusion: non_null

# ===============================================
# Eureka Client Configuration (Production)
# ===============================================
eureka:
  client:
    enabled: true
    service-url:
      defaultZone: ${EUREKA_SERVER_URL:http://service-registry:8761/eureka/}
    fetch-registry: true
    register-with-eureka: true
    registry-fetch-interval-seconds: 30
  instance:
    prefer-ip-address: true
    lease-renewal-interval-in-seconds: 30
    lease-expiration-duration-in-seconds: 90
    metadata-map:
      version: "@project.version@"
      environment: production

# ===============================================
# Resilience4j Circuit Breaker (Production)
# ===============================================
resilience4j:
  circuitbreaker:
    instances:
      authService:
        failure-rate-threshold: 50
        slow-call-rate-threshold: 50
        slow-call-duration-threshold: 5s
        wait-duration-in-open-state: 30s
        permitted-number-of-calls-in-half-open-state: 5
        sliding-window-size: 100
        sliding-window-type: COUNT_BASED
        minimum-number-of-calls: 10
        automatic-transition-from-open-to-half-open-enabled: true

      userService:
        failure-rate-threshold: 50
        wait-duration-in-open-state: 30s
        sliding-window-size: 100

      notificationService:
        failure-rate-threshold: 70  # More lenient for non-critical service
        wait-duration-in-open-state: 20s
        sliding-window-size: 50

  retry:
    instances:
      default:
        max-attempts: 3
        wait-duration: 1s
        enable-exponential-backoff: true
        exponential-backoff-multiplier: 1.5

# ===============================================
# Gateway Configuration (Production)
# ===============================================
gateway:
  base-url: ${GATEWAY_URL:http://api-gateway:8088/api}
  timeout:
    connect: 5000
    read: 30000
  retry:
    max-attempts: 3
    delay-ms: 1000
    backoff-multiplier: 1.5

# ===============================================
# USSD Security (Production - STRICT)
# ===============================================
ussd:
  security:
    # Africa's Talking Production IPs
    allowed-ips:
      - 196.216.167.0/24
      - 196.216.168.0/24
      - 41.210.142.0/24
    enable-ip-whitelist: true  # CRITICAL: Always enabled in production
    max-requests-per-minute: 200
    max-requests-per-hour: 5000
    rate-limit-window-minutes: 1
    max-request-size: 2048
    sanitize-input: true
    validate-headers: true
    require-user-agent: true
    log-security-events: true
    alert-on-violations: true
    block-suspicious-requests: true
    suspicious-request-threshold: 5

  session:
    timeout-minutes: 5
    cleanup-interval-minutes: 2
    max-concurrent-sessions: 5000
    storage:
      type: redis  # Production uses Redis
      key-prefix: "ussd:session:"
      enable-persistence: true

  features:
    registration-enabled: true
    opportunity-search-enabled: true
    profile-management-enabled: true
    sms-notifications-enabled: true

# ===============================================
# External Integrations (Production)
# ===============================================
sms:
  service:
    enabled: true
    provider: africas_talking
    api-key: ${SMS_API_KEY}  # Stored in secrets manager
    username: ${SMS_USERNAME}
    sender-id: YouthConnect
    max-retry-attempts: 3

notification:
  service:
    enabled: true
    channels:
      - ussd
      - sms
      - email

# ===============================================
# Monitoring & Logging (Production)
# ===============================================
management:
  endpoints:
    web:
      exposure:
        include:
          - health
          - info
          - metrics
          - prometheus
      base-path: /actuator
  endpoint:
    health:
      show-details: when-authorized
      show-components: always
      probes:
        enabled: true
  health:
    livenessstate:
      enabled: true
    readinessstate:
      enabled: true
    db:
      enabled: true
    redis:
      enabled: true
  metrics:
    enabled: true
    export:
      prometheus:
        enabled: true
        step: 1m
    distribution:
      percentiles-histogram:
        http.server.requests: true
      slo:
        http.server.requests:
          - 50ms
          - 100ms
          - 200ms
          - 500ms
          - 1s
          - 2s
  metrics.tags:
    application: ${spring.application.name}
    environment: production
    version: "@project.version@"
    region: ${DEPLOYMENT_REGION:uganda-central}

# ===============================================
# Production Logging
# ===============================================
logging:
  level:
    root: WARN
    com.youthconnect.ussd_service: INFO
    com.youthconnect.ussd_service.controller: INFO
    com.youthconnect.ussd_service.service: INFO
    com.youthconnect.ussd_service.security: WARN
    org.springframework.web: WARN
    org.springframework.security: WARN
    org.springframework.cloud: INFO
    reactor.netty: WARN
    io.micrometer: WARN
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level [%X{sessionId:-}] %logger{50} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level [%X{sessionId:-}] [%X{phoneNumber:-}] %logger{50} - %msg%n"
  file:
    name: /var/log/youth-connect/ussd-service.log
    max-size: 100MB
    max-history: 60
    total-size-cap: 5GB
  logback:
    rollingpolicy:
      clean-history-on-start: false
      file-name-pattern: /var/log/youth-connect/ussd-service-%d{yyyy-MM-dd}.%i.log.gz

# ===============================================
# Production Flags
# ===============================================
debug:
  enable-test-endpoints: false
  log-request-details: false
  skip-security-validation: false
  mock-external-services: false