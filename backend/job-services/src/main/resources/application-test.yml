# ============================================================================
# Test Profile Configuration
# Author: Douglas Kings Kato
# Description: Configuration for unit and integration tests
# ============================================================================

spring:
  config:
    activate:
      on-profile: test

  # ============================================================================
  # DATABASE - TEST (IN-MEMORY H2)
  # ============================================================================
  datasource:
    # H2 in-memory database for tests (fast and isolated)
    url: jdbc:h2:mem:testdb;MODE=PostgreSQL;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE
    driver-class-name: org.h2.Driver
    username: sa
    password: ""

    # H2 connection pool settings
    hikari:
      maximum-pool-size: 5
      minimum-idle: 2

  # ============================================================================
  # JPA - TEST
  # ============================================================================
  jpa:
    hibernate:
      # Create schema from entities for tests
      # Alternative: Use Flyway for tests too (more realistic)
      ddl-auto: create-drop

    # Hide SQL in tests (less noise)
    show-sql: false

    properties:
      hibernate:
        # H2 dialect with PostgreSQL compatibility
        dialect: org.hibernate.dialect.H2Dialect

        # No SQL formatting in tests
        format_sql: false
        use_sql_comments: false

  # ============================================================================
  # FLYWAY - TEST
  # ============================================================================
  flyway:
    # Option 1: Disable Flyway for tests (use Hibernate ddl-auto)
    enabled: false

    # Option 2: Enable Flyway for integration tests (uncomment below)
    # This makes tests more realistic but slower
    # enabled: true
    # locations: classpath:db/migration
    # baseline-on-migrate: true
    # clean-disabled: false
    # clean-on-validation-error: true

  # ============================================================================
  # H2 CONSOLE (Optional for debugging tests)
  # ============================================================================
  h2:
    console:
      enabled: true
      path: /h2-console

  # ============================================================================
  # REDIS - TEST (EMBEDDED)
  # ============================================================================
  data:
    redis:
      # Use embedded Redis for tests
      host: localhost
      port: 6370  # Different port to avoid conflicts
      password: ""

# ============================================================================
# LOGGING - TEST
# ============================================================================
logging:
  level:
    # Minimal logging for tests (reduce noise)
    root: WARN

    # Application logs for debugging test failures
    com.youthconnect.job_services: DEBUG

    # Hide SQL in tests (too verbose)
    org.hibernate.SQL: WARN
    org.hibernate.type.descriptor.sql.BasicBinder: WARN

    # Hide Spring framework logs
    org.springframework: WARN

    # Hide Flyway logs if enabled
    org.flywaydb: WARN

    # Hide HikariCP logs
    com.zaxxer.hikari: WARN

# ============================================================================
# EUREKA - TEST
# ============================================================================
eureka:
  client:
    # Disable Eureka for tests
    enabled: false
    register-with-eureka: false
    fetch-registry: false

# ============================================================================
# ACTUATOR - TEST
# ============================================================================
management:
  endpoints:
    web:
      exposure:
        include: health,info

  endpoint:
    health:
      show-details: always

# ============================================================================
# APPLICATION-SPECIFIC - TEST
# ============================================================================
app:
  # Security settings for tests
  security:
    jwt:
      # Test JWT secret (different from dev/prod)
      secret: test-secret-key-youth-connect-2025-minimum-256-bits-required-for-tests
      access-token-expiry: 900
      refresh-token-expiry: 604800

  # Job settings for tests
  job:
    max-page-size: 100
    default-page-size: 20
    max-applications-per-day: 20
    max-pending-applications: 50

# ============================================================================
# TEST NOTES
# ============================================================================
# This profile is for automated tests (JUnit, Integration tests). Features:
#
# 1. DATABASE:
#    - H2 in-memory database (fast, isolated)
#    - PostgreSQL compatibility mode
#    - Schema created from entities (create-drop)
#    - Each test gets fresh database
#
# 2. FLYWAY:
#    - Disabled by default (Hibernate manages schema)
#    - Can be enabled for integration tests
#
# 3. EXTERNAL SERVICES:
#    - Eureka disabled
#    - Embedded Redis
#    - Mock external APIs
#
# 4. LOGGING:
#    - Minimal logging to reduce test output
#    - Application logs at DEBUG for debugging
#
# 5. USAGE:
#    - Automatically activated by @SpringBootTest(webEnvironment = ...)
#    - Or set SPRING_PROFILES_ACTIVE=test
#    - Or use @ActiveProfiles("test") on test classes
#
# 6. TEST DATABASE OPTIONS:
#    a) H2 with create-drop (current setup)
#       - Pros: Fast, isolated
#       - Cons: Not 100% PostgreSQL compatible
#
#    b) H2 with Flyway (enable flyway above)
#       - Pros: Tests actual migrations
#       - Cons: Slower
#
#    c) Testcontainers with PostgreSQL (add separate config)
#       - Pros: 100% production-like
#       - Cons: Requires Docker, slower
# ============================================================================