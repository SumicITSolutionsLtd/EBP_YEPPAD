# ============================================================================
# FILE 1: docker-compose.yml (Development Setup with PostgreSQL)
# ============================================================================

version: '3.8'

services:
  # ============================================================================
  # POSTGRESQL DATABASE SERVICE
  # ============================================================================
  # Production-grade PostgreSQL 15 with Alpine Linux (lightweight)
  # Includes persistent storage, health checks, and proper configuration
  postgres:
    image: postgres:15-alpine
    container_name: job-service-postgres-dev
    
    # Environment variables for PostgreSQL initialization
    environment:
      # Database name to create on first startup
      POSTGRES_DB: job_service_db
      
      # Superuser credentials
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      
      # Character encoding (UTF-8 for international support)
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=en_US.UTF-8"
      
      # Timezone configuration
      TZ: Africa/Nairobi
      PGTZ: Africa/Nairobi
      
      # Shared buffers (25% of RAM recommended)
      POSTGRES_SHARED_BUFFERS: 256MB
      
      # Effective cache size
      POSTGRES_EFFECTIVE_CACHE_SIZE: 1GB
      
      # Maintenance work memory
      POSTGRES_MAINTENANCE_WORK_MEM: 64MB
      
      # Work memory per operation
      POSTGRES_WORK_MEM: 4MB
    
    # Port mapping: host:container
    # PostgreSQL default port is 5432
    ports:
      - "5432:5432"
    
    # Volume mounts for data persistence and initialization
    volumes:
      # Persistent data storage
      # All PostgreSQL data is stored here and survives container restarts
      - postgres_data:/var/lib/postgresql/data
      
      # Database initialization scripts
      # SQL files here are executed on first container startup
      # Useful for creating schema, inserting seed data
      - ./src/main/resources/db/migration:/docker-entrypoint-initdb.d:ro
      
      # Custom PostgreSQL configuration (optional)
      # - ./postgresql.conf:/etc/postgresql/postgresql.conf:ro
    
    # Docker network for service communication
    networks:
      - job-service-network
    
    # Container restart policy
    # "unless-stopped" means restart always except when manually stopped
    restart: unless-stopped
    
    # Health check to ensure PostgreSQL is ready
    # Spring Boot will wait for this before connecting
    healthcheck:
      # Command to check if PostgreSQL is accepting connections
      test: ["CMD-SHELL", "pg_isready -U postgres -d job_service_db"]
      
      # Wait 10 seconds before first health check
      interval: 10s
      
      # Health check timeout
      timeout: 5s
      
      # Number of retries before marking as unhealthy
      retries: 5
      
      # Wait 30 seconds after container starts before checking
      start_period: 30s
    
    # Resource limits (optional but recommended)
    deploy:
      resources:
        limits:
          cpus: '1.0'      # Maximum CPU usage
          memory: 1G       # Maximum memory
        reservations:
          cpus: '0.5'      # Reserved CPU
          memory: 512M     # Reserved memory
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"    # Maximum log file size
        max-file: "3"      # Maximum number of log files

  # ============================================================================
  # REDIS CACHE SERVICE
  # ============================================================================
  # Redis 7 for caching and session storage
  redis:
    image: redis:7-alpine
    container_name: job-service-redis-dev
    
    # Redis server configuration via command line
    command: >
      redis-server
      --requirepass redis_password
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --appendonly yes
      --appendfsync everysec
      --save 900 1
      --save 300 10
      --save 60 10000
    
    # Port mapping
    ports:
      - "6379:6379"
    
    # Volume for Redis persistence
    volumes:
      - redis_data:/data
    
    # Docker network
    networks:
      - job-service-network
    
    # Restart policy
    restart: unless-stopped
    
    # Health check
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "redis_password", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    
    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "3"

  # ============================================================================
  # EUREKA SERVICE REGISTRY
  # ============================================================================
  # Netflix Eureka for service discovery
  eureka-server:
    image: springcloud/eureka:latest
    container_name: job-service-eureka-dev
    
    # Environment variables
    environment:
      - SPRING_PROFILES_ACTIVE=dev
      - SERVER_PORT=8761
    
    # Port mapping
    ports:
      - "8761:8761"
    
    # Docker network
    networks:
      - job-service-network
    
    # Restart policy
    restart: unless-stopped
    
    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8761/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "3"

  # ============================================================================
  # JOB SERVICE APPLICATION
  # ============================================================================
  # Main Spring Boot application
  job-service:
    # Build from Dockerfile in current directory
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
        - VCS_REF=$(git rev-parse --short HEAD)
    
    container_name: job-service-app-dev
    
    # Port mapping
    ports:
      - "8000:8000"
    
    # Environment variables (override application.yml)
    environment:
      # ===== Spring Configuration =====
      SPRING_PROFILES_ACTIVE: dev
      
      # ===== PostgreSQL Configuration =====
      # Use service name 'postgres' as hostname (Docker DNS)
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/job_service_db
      SPRING_DATASOURCE_USERNAME: postgres
      SPRING_DATASOURCE_PASSWORD: postgres
      SPRING_DATASOURCE_DRIVER_CLASS_NAME: org.postgresql.Driver
      
      # ===== JPA/Hibernate Configuration =====
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_JPA_SHOW_SQL: "true"
      SPRING_JPA_PROPERTIES_HIBERNATE_DIALECT: org.hibernate.dialect.PostgreSQLDialect
      SPRING_JPA_PROPERTIES_HIBERNATE_FORMAT_SQL: "true"
      
      # ===== Redis Configuration =====
      SPRING_DATA_REDIS_HOST: redis
      SPRING_DATA_REDIS_PORT: 6379
      SPRING_DATA_REDIS_PASSWORD: redis_password
      
      # ===== Eureka Configuration =====
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eureka-server:8761/eureka/
      EUREKA_INSTANCE_PREFER_IP_ADDRESS: "true"
      EUREKA_INSTANCE_HOSTNAME: job-service
      
      # ===== Logging Configuration =====
      LOGGING_LEVEL_ROOT: INFO
      LOGGING_LEVEL_COM_YOUTHCONNECT_JOB_SERVICES: DEBUG
      
      # ===== JVM Options =====
      JAVA_OPTS: >
        -Xms512m
        -Xmx1024m
        -XX:+UseG1GC
        -XX:MaxGCPauseMillis=200
        -XX:+HeapDumpOnOutOfMemoryError
        -XX:HeapDumpPath=/app/logs/heap_dump.hprof
        -Djava.security.egd=file:/dev/./urandom
      
      # ===== Application Configuration =====
      SERVER_PORT: 8000
      
      # ===== External Service URLs =====
      USER_SERVICE_URL: http://user-service:8081
      NOTIFICATION_SERVICE_URL: http://notification-service:8086
      AI_SERVICE_URL: http://ai-service:8087
      
      # ===== Security Configuration =====
      JWT_SECRET: youth-connect-secure-secret-key-2025-for-docker-development-only
      
      # ===== File Upload Configuration =====
      UPLOAD_DIR: /var/app/uploads
    
    # Wait for dependent services to be healthy
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      eureka-server:
        condition: service_healthy
    
    # Docker network
    networks:
      - job-service-network
    
    # Volume mounts
    volumes:
      # Application logs
      - ./logs:/app/logs
      
      # File uploads
      - ./uploads:/var/app/uploads
      
      # Spring Boot DevTools (for live reload)
      - ./target:/app/target:ro
    
    # Restart policy
    restart: unless-stopped
    
    # Health check
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s  # Wait 90s for Spring Boot to start
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
    
    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

# ============================================================================
# DOCKER NETWORKS
# ============================================================================
# Bridge network for internal service communication
networks:
  job-service-network:
    driver: bridge
    name: job-service-network
    ipam:
      config:
        - subnet: 172.28.0.0/16

# ============================================================================
# DOCKER VOLUMES
# ============================================================================
# Named volumes for data persistence
volumes:
  # PostgreSQL data volume
  postgres_data:
    driver: local
    name: job-service-postgres-data
  
  # Redis data volume
  redis_data:
    driver: local
    name: job-service-redis-data