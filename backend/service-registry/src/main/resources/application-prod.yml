# ================================================================================
# Service Registry (Eureka Server) - PRODUCTION Configuration
# ================================================================================
# Profile: prod (activated with: SPRING_PROFILES_ACTIVE=prod)
# ⚠️ CRITICAL: Review all settings before deploying to production
# ================================================================================

spring:
  application:
    name: service-registry

  # Production Security Configuration
  # These credentials MUST be changed from defaults in production
  security:
    user:
      # Production username (override via EUREKA_USERNAME environment variable)
      # ⚠️ DO NOT use 'admin' in production!
      name: ${EUREKA_USERNAME:admin}

      # Production password (override via EUREKA_PASSWORD environment variable)
      # ⚠️ MUST be a strong password (min 16 characters, mixed case, numbers, symbols)
      # ⚠️ Use secrets management (AWS Secrets Manager, HashiCorp Vault, etc.)
      password: ${EUREKA_PASSWORD:changeme_in_production}

# ================================================================================
# Server Configuration - PRODUCTION
# ================================================================================
server:
  port: 8761

  # Enable response compression for production
  compression:
    enabled: true

  # Production Tomcat settings (optimized for higher load)
  tomcat:
    threads:
      max: 400          # More threads for production traffic
      min-spare: 20     # Keep more spare threads ready
    max-connections: 8192    # Max concurrent connections
    accept-count: 100        # Queue size for connections when all threads busy

# ================================================================================
# Eureka Server Configuration - PRODUCTION
# ================================================================================
eureka:
  instance:
    # Production hostname (usually load balancer or DNS name)
    hostname: ${EUREKA_HOSTNAME:service-registry}

    # ✅ In production with load balancer, prefer IP address
    # Set to false if using hostname-based routing
    prefer-ip-address: true

    # Production heartbeat settings (more relaxed than dev/docker)
    lease-renewal-interval-in-seconds: 30      # Heartbeat every 30 seconds
    lease-expiration-duration-in-seconds: 90   # Wait 90s before marking as down

  client:
    # Standalone mode (don't register with itself)
    register-with-eureka: false
    fetch-registry: false

    # Production service URL
    # ✅ In clustered setup, point to all Eureka instances
    # Example: http://eureka1:8761/eureka/,http://eureka2:8761/eureka/
    service-url:
      defaultZone: ${EUREKA_SERVER_URL:http://localhost:8761/eureka/}

  server:
    # ✅ PRODUCTION: ENABLE self-preservation
    # Prevents mass eviction during network partitions
    # Critical for production stability
    enable-self-preservation: true

    # Check for expired instances less frequently in production
    eviction-interval-timer-in-ms: 15000  # Every 15 seconds

    # Response cache (balance performance vs freshness)
    # Higher values = better performance but less real-time updates
    response-cache-auto-expiration-in-seconds: 180  # 3 minutes
    response-cache-update-interval-ms: 30000         # Update every 30s

    # ✅ Rate limiting (stricter in production to prevent abuse)
    rate-limiter-enabled: true
    rate-limiter-burst-size: 50                     # Lower burst capacity
    rate-limiter-registry-fetch-average-rate: 500   # Max avg requests/sec
    rate-limiter-full-fetch-average-rate: 100       # Max full fetch/sec

# ================================================================================
# Management - PRODUCTION (Restricted)
# ================================================================================
management:
  endpoints:
    web:
      # ✅ Expose only essential endpoints in production
      # Removed 'gateway' endpoint for security
      exposure:
        include: health,info,metrics,prometheus
      base-path: /actuator

  endpoint:
    health:
      # ✅ Hide health details from unauthorized users
      # Only show details when authenticated
      show-details: when-authorized
      show-components: when-authorized

  metrics:
    export:
      prometheus:
        enabled: true

# ================================================================================
# Logging - PRODUCTION (Less Verbose)
# ================================================================================
logging:
  level:
    root: WARN                                   # Only warnings and errors
    com.netflix.eureka: INFO                     # Eureka core logs
    com.netflix.discovery: INFO                  # Discovery logs
    com.youthconnect.service_registry: INFO      # Application logs

  # Production log file configuration
  file:
    name: /var/log/youth-connect/service-registry.log
    max-size: 100MB       # Larger files in production
    max-history: 60       # Keep 60 days of logs
    total-size-cap: 5GB   # Max 5GB of logs

# ================================================================================
# Application Info
# ================================================================================
info:
  app:
    name: ${spring.application.name}
    description: Service Registry for YouthConnect Uganda Platform (Production)
    version: '@project.version@'
    encoding: '@project.build.sourceEncoding@'
    java:
      version: '@java.version@'
  environment: production

# ================================================================================
# ✅ PRODUCTION DEPLOYMENT CHECKLIST
# ================================================================================
#
# SECURITY:
# ─────────────────────────────────────────────────────────────────────────────
# ☐ Change EUREKA_USERNAME from 'admin' to something unique
# ☐ Generate strong EUREKA_PASSWORD (min 16 chars, mixed case, numbers, symbols)
# ☐ Store credentials in secrets management (AWS Secrets Manager, Vault)
# ☐ Enable HTTPS (configure SSL/TLS certificates)
# ☐ Configure Spring Security for role-based access control
# ☐ Restrict actuator endpoints with authentication
# ☐ Enable firewall rules (only allow necessary ports)
#
# HIGH AVAILABILITY:
# ─────────────────────────────────────────────────────────────────────────────
# ☐ Deploy multiple Eureka instances (3+ for production)
# ☐ Configure peer-to-peer replication between Eureka servers
# ☐ Use load balancer in front of Eureka instances
# ☐ Set up health checks in load balancer
# ☐ Enable self-preservation mode (already enabled above)
#
# MONITORING:
# ─────────────────────────────────────────────────────────────────────────────
# ☐ Set up Prometheus + Grafana for metrics
# ☐ Configure alerts for:
#    - Service instance count drops
#    - High CPU/memory usage
#    - Circuit breaker opens
#    - High error rates
# ☐ Enable centralized logging (ELK, CloudWatch, Splunk)
# ☐ Set up APM (Application Performance Monitoring)
#
# PERFORMANCE:
# ─────────────────────────────────────────────────────────────────────────────
# ☐ Tune JVM heap size based on traffic (see startup scripts)
# ☐ Enable G1GC or ZGC for better garbage collection
# ☐ Configure connection pools appropriately
# ☐ Monitor response times and latency
# ☐ Set up CDN for static resources (if serving dashboard publicly)
#
# BACKUP & DISASTER RECOVERY:
# ─────────────────────────────────────────────────────────────────────────────
# ☐ Document disaster recovery procedures
# ☐ Test failover scenarios
# ☐ Set up automated backups of configuration
# ☐ Have rollback plan ready
#
# EXAMPLE PRODUCTION STARTUP:
# ─────────────────────────────────────────────────────────────────────────────
# java -jar service-registry.jar \
#   --spring.profiles.active=prod \
#   -Xms1g -Xmx2g \
#   -XX:+UseG1GC \
#   -Deureka.username=${VAULT_EUREKA_USERNAME} \
#   -Deureka.password=${VAULT_EUREKA_PASSWORD}
#
# ================================================================================