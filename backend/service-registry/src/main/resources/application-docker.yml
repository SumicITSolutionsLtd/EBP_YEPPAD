# ================================================================================
# Service Registry (Eureka Server) - Docker Configuration
# ================================================================================
# This configuration is activated when running in Docker containers
# Profile: docker (activated with: SPRING_PROFILES_ACTIVE=docker)
# ================================================================================

spring:
  application:
    name: service-registry

  #Security configuration for Docker environment
  # These credentials secure the Eureka dashboard and client authentication
  security:
    user:
      # Username for Eureka authentication (dashboard login + client connections)
      # Default: admin (can be overridden via EUREKA_USERNAME env var)
      name: ${EUREKA_USERNAME:admin}

      # Password for Eureka authentication (dashboard login + client connections)
      # Default: changeme (can be overridden via EUREKA_PASSWORD env var)
      # ⚠️ IMPORTANT: Change in production!
      password: ${EUREKA_PASSWORD:changeme}

# ================================================================================
# Server Configuration for Docker
# ================================================================================
server:
  port: 8761  # Standard Eureka port (exposed in Docker)

  # Enable compression for better network performance in containers
  compression:
    enabled: true
    mime-types: text/html,text/xml,text/plain,application/json,application/xml
    min-response-size: 1024  # Compress responses larger than 1KB

# ================================================================================
# Eureka Server Configuration for Docker
# ================================================================================
eureka:
  instance:
    # ✅ Use container hostname for Docker networking
    # This allows other containers to discover this Eureka server by name
    hostname: ${EUREKA_HOSTNAME:service-registry}

    # Use hostname instead of IP for container-to-container communication
    prefer-ip-address: false

    # ✅ Faster heartbeat for container environments
    # Containers can restart/move frequently, so shorter intervals help
    lease-renewal-interval-in-seconds: 10      # Heartbeat every 10 seconds
    lease-expiration-duration-in-seconds: 30   # Mark as down after 30 seconds

    # Instance metadata (useful for monitoring)
    metadata-map:
      zone: docker                              # Deployment zone
      environment: container                     # Environment type
      version: '@project.version@'              # Application version

  client:
    # ✅ Standalone mode - don't register with itself
    register-with-eureka: false
    fetch-registry: false

    # ✅ Service URL for other containers to discover this registry
    # Format: http://username:password@hostname:port/eureka/
    # Other containers will use this URL to connect
    service-url:
      defaultZone: http://${EUREKA_USERNAME:admin}:${EUREKA_PASSWORD:changeme}@${EUREKA_HOSTNAME:service-registry}:8761/eureka/

    # ✅ Faster registry fetch for container environments
    # Containers need quicker updates due to potential rapid changes
    registry-fetch-interval-seconds: 10

  server:
    # ✅ ENABLE self-preservation in Docker
    # Network issues are more common in containerized environments
    # Self-preservation prevents premature instance eviction during network glitches
    enable-self-preservation: true
    renewal-percent-threshold: 0.85  # 85% of instances must send heartbeat

    # Eviction settings for container environments
    eviction-interval-timer-in-ms: 10000  # Check for expired instances every 10s

    # Response cache (balance between consistency and performance)
    response-cache-auto-expiration-in-seconds: 60
    response-cache-update-interval-ms: 10000

    # Peer replication for cluster mode (if running multiple Eureka instances)
    peer-eureka-nodes-update-interval-ms: 15000
    peer-eureka-status-refresh-time-interval-ms: 15000

    # Rate limiting (same as development for Docker)
    rate-limiter-enabled: true
    rate-limiter-burst-size: 100
    rate-limiter-registry-fetch-average-rate: 500

# ================================================================================
# Management & Monitoring for Docker
# ================================================================================
management:
  endpoints:
    web:
      exposure:
        include:
          - health          # Health check (for Docker healthcheck)
          - info            # Application info
          - metrics         # Metrics
          - prometheus      # Prometheus metrics
          - env             # Environment variables
          - loggers         # Logger configuration
      base-path: /actuator

  endpoint:
    health:
      # Always show health details (useful for Docker troubleshooting)
      show-details: always
      show-components: always

      # ✅ Enable Kubernetes-style probes
      # Docker/Kubernetes can use these for health checks
      probes:
        enabled: true

  health:
    # Liveness probe: Is the application running?
    livenessstate:
      enabled: true

    # Readiness probe: Is the application ready to accept traffic?
    readinessstate:
      enabled: true

    # Disk space check (important in containers with limited storage)
    diskspace:
      enabled: true
      threshold: 100MB  # Alert if less than 100MB free

  metrics:
    enabled: true
    export:
      prometheus:
        enabled: true
        step: 1m  # Scrape interval for Prometheus

  info:
    env:
      enabled: true
    java:
      enabled: true
    os:
      enabled: true

# ================================================================================
# Logging Configuration for Docker
# ================================================================================
logging:
  level:
    root: INFO
    com.netflix.eureka: INFO
    com.netflix.discovery: INFO
    com.youthconnect.service_registry: INFO

  # ✅ Structured logging for Docker/Kubernetes
  # Docker captures stdout/stderr, so we log to console
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{50} - %msg%n"

  # ✅ Log to file inside container (optional, usually log to stdout in Docker)
  # Docker can also mount a volume to persist logs
  file:
    name: /var/log/youth-connect/service-registry.log
    max-size: 50MB
    max-history: 7      # Keep only 7 days in container
    total-size-cap: 500MB

# ================================================================================
# Application Info
# ================================================================================
info:
  app:
    name: ${spring.application.name}
    description: Service Registry for YouthConnect Uganda Platform (Docker)
    version: '@project.version@'
    encoding: '@project.build.sourceEncoding@'
    java:
      version: '@java.version@'
  environment: docker
  container: true

# ================================================================================
# ✅ DOCKER USAGE INSTRUCTIONS
# ================================================================================
# 1. Build Docker Image:
#    docker build -t youthconnect/service-registry:2.0.0 .
#
# 2. Run Container:
#    docker run -d \
#      --name service-registry \
#      -p 8761:8761 \
#      -e SPRING_PROFILES_ACTIVE=docker \
#      -e EUREKA_USERNAME=admin \
#      -e EUREKA_PASSWORD=secure_password \
#      youthconnect/service-registry:2.0.0
#
# 3. Access Dashboard:
#    URL: http://localhost:8761
#    Username: admin
#    Password: secure_password
#
# 4. Health Check:
#    curl http://localhost:8761/actuator/health
#
# 5. Other containers connect with:
#    eureka.client.service-url.defaultZone=http://admin:secure_password@service-registry:8761/eureka/
#
# 6. Docker Compose:
#    See docker-compose.yml in service-registry root directory
# ================================================================================