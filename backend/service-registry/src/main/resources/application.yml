# ================================================================================
# Service Registry (Eureka Server) - FIXED Configuration
# ================================================================================
# ✅ FIXES APPLIED:
#   1. Enhanced JSON encoder configuration
#   2. Proper content-type response headers
#   3. Improved client compatibility settings
#
# Version: 3.0.0 (FIXED)
# Last Updated: 2024-11-24
# ================================================================================

spring:
  application:
    name: service-registry

  # ✅ Spring Security User Configuration
  # These credentials secure Eureka dashboard and client authentication
  security:
    user:
      name: ${EUREKA_USERNAME:admin}
      password: ${EUREKA_PASSWORD:changeme}

  # ✅ FIX #1: HTTP Message Converters Configuration
  # Ensures Eureka sends proper JSON responses with correct content-type
  http:
    converters:
      # Preferred order of message converters
      preferred-json-mapper: jackson

  # ✅ FIX #2: Jackson Configuration for Eureka
  # Ensures all JSON responses use Jackson with proper content-type
  jackson:
    serialization:
      # Write dates as ISO-8601 strings
      write-dates-as-timestamps: false
      # Indent JSON for readability
      indent-output: false
    deserialization:
      # Don't fail on unknown properties
      fail-on-unknown-properties: false
    default-property-inclusion: non_null

  # Banner configuration
  banner:
    location: classpath:banner.txt

# ================================================================================
# Server Configuration
# ================================================================================
server:
  port: ${SERVER_PORT:8761}

  # ✅ FIX #3: Enable response compression with proper content-type headers
  compression:
    enabled: true
    mime-types: application/json,application/xml,text/html,text/xml,text/plain

  # Tomcat configuration
  tomcat:
    threads:
      max: 200
      min-spare: 10
    connection-timeout: 20000

# ================================================================================
# ✅ ENHANCED: Eureka Server Configuration
# ================================================================================
eureka:
  instance:
    hostname: ${HOSTNAME:localhost}
    prefer-ip-address: false

    # Heartbeat configuration
    lease-renewal-interval-in-seconds: 10
    lease-expiration-duration-in-seconds: 30

  client:
    # Standalone Eureka Server Mode
    register-with-eureka: false
    fetch-registry: false

    # Service URL
    service-url:
      defaultZone: http://${HOSTNAME:localhost}:${SERVER_PORT:8761}/eureka/

    registry-fetch-interval-seconds: 5

  server:
    # ✅ Development: Disable self-preservation (enable in production)
    enable-self-preservation: false

    # How often to check for expired instances
    eviction-interval-timer-in-ms: 5000

    # ✅ FIX #4: Response Cache Configuration
    # Ensures clients get JSON responses with proper content-type
    response-cache-auto-expiration-in-seconds: 30
    response-cache-update-interval-ms: 5000

    # ✅ FIX #5: Use Registry Response Cache
    # This helps ensure consistent content-type in responses
    use-read-only-response-cache: true

    # ✅ FIX #6: JSON Codec Configuration
    # Force Eureka to use Jackson JSON codec
    json-codec-name: jackson

    # ✅ FIX #7: XML Codec Configuration
    # Disable XML codec to force JSON (prevents content-type confusion)
    xml-codec-name: jackson

    # Peer replication settings
    peer-eureka-nodes-update-interval-ms: 10000
    peer-eureka-status-refresh-time-interval-ms: 10000

    # Rate limiting
    rate-limiter-enabled: true
    rate-limiter-burst-size: 100
    rate-limiter-registry-fetch-average-rate: 500
    rate-limiter-full-fetch-average-rate: 100

    # ✅ FIX #8: Disable gzip compression for responses
    # Some clients have issues with gzipped JSON responses
    # Enable only if all clients support it
    enable-response-compression: false

  # ✅ FIX #9: Dashboard Configuration
  # Ensures dashboard works properly with authentication
  dashboard:
    enabled: true
    path: /

# ================================================================================
# ✅ FIX #10: Management & Monitoring Configuration
# ================================================================================
management:
  endpoints:
    web:
      exposure:
        include:
          - health
          - info
          - metrics
          - prometheus
          - env
      base-path: /actuator

      # ✅ Ensure actuator endpoints return JSON with proper content-type
      cors:
        allowed-origins: "*"
        allowed-methods: "GET,POST"

  endpoint:
    health:
      show-details: always
      show-components: always

  health:
    livenessstate:
      enabled: true
    readinessstate:
      enabled: true

  metrics:
    enabled: true
    export:
      prometheus:
        enabled: true

  info:
    env:
      enabled: true
    java:
      enabled: true
    os:
      enabled: true

# ================================================================================
# Logging Configuration
# ================================================================================
logging:
  level:
    root: INFO
    com.netflix.eureka: INFO
    com.netflix.discovery: INFO
    com.youthconnect.service_registry: DEBUG

    # ✅ Log HTTP message converter issues
    org.springframework.http.converter: DEBUG
    org.springframework.web.servlet.mvc: DEBUG

  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{50} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{50} - %msg%n"

  file:
    name: logs/service-registry.log
    max-size: 50MB
    max-history: 30
    total-size-cap: 1GB

# ================================================================================
# Application Info
# ================================================================================
info:
  app:
    name: ${spring.application.name}
    description: Service Registry for YouthConnect Uganda Platform (FIXED)
    version: '@project.version@'
    encoding: '@project.build.sourceEncoding@'
    java:
      version: '@java.version@'
  fixes:
    - "Enhanced JSON encoder configuration"
    - "Proper content-type response headers"
    - "Improved client compatibility"
    - "Disabled XML codec to force JSON"

# ================================================================================
# ✅ VERIFICATION COMMANDS
# ================================================================================
# 1. Test Eureka endpoint returns proper JSON:
#    curl -H "Accept: application/json" \
#         -u admin:changeme \
#         http://localhost:8761/eureka/apps
#
# 2. Check response headers:
#    curl -I -u admin:changeme http://localhost:8761/eureka/apps
#    Should show: Content-Type: application/json
#
# 3. Test dashboard login:
#    http://localhost:8761
#    Username: admin
#    Password: changeme
# ================================================================================