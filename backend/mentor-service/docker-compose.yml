# =============================================================================
# Docker Compose for Mentor Service Development Environment
# =============================================================================
version: '3.9'

services:
  # ===========================================================================
  # PostgreSQL Database
  # ===========================================================================
  mentor-db:
    image: postgres:16-alpine
    container_name: mentor-db
    environment:
      POSTGRES_DB: ${DB_NAME:-youthconnect_db}
      POSTGRES_USER: ${DB_USERNAME:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-postgres}
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=en_US.UTF-8"
    ports:
      - "${DB_PORT:-5432}:5432"
    volumes:
      - mentor-db-data:/var/lib/postgresql/data
      - ./db/migration:/docker-entrypoint-initdb.d:ro
    networks:
      - youth-connect-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ===========================================================================
  # Mentor Service Application
  # ===========================================================================
  mentor-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mentor-service
    depends_on:
      mentor-db:
        condition: service_healthy
      service-registry:
        condition: service_healthy
    environment:
      # Spring Profile
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-dev}

      # Database Configuration
      DB_HOST: mentor-db
      DB_PORT: 5432
      DB_NAME: ${DB_NAME:-youthconnect_db}
      DB_USERNAME: ${DB_USERNAME:-postgres}
      DB_PASSWORD: ${DB_PASSWORD:-postgres}

      # Service Registry
      EUREKA_URI: http://service-registry:8761/eureka/

      # Service URLs
      USER_SERVICE_URL: ${USER_SERVICE_URL:-http://user-service:8081}
      NOTIFICATION_SERVICE_URL: ${NOTIFICATION_SERVICE_URL:-http://notification-service:8086}

      # JPA/Hibernate
      JPA_DDL_AUTO: ${JPA_DDL_AUTO:-validate}
      JPA_SHOW_SQL: ${JPA_SHOW_SQL:-false}

      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-DEBUG}

      # Server
      SERVER_PORT: 8090
    ports:
      - "${SERVER_PORT:-8090}:8090"
    volumes:
      - mentor-logs:/app/logs
    networks:
      - youth-connect-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8090/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    restart: unless-stopped

  # ===========================================================================
  # Service Registry (Eureka) - If not already running
  # ===========================================================================
  service-registry:
    image: youthconnect/service-registry:latest
    container_name: service-registry
    environment:
      SERVER_PORT: 8761
    ports:
      - "8761:8761"
    networks:
      - youth-connect-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8761/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
    restart: unless-stopped

# =============================================================================
# Networks
# =============================================================================
networks:
  youth-connect-network:
    name: youth-connect-network
    driver: bridge

# =============================================================================
# Volumes
# =============================================================================
volumes:
  mentor-db-data:
    name: mentor-db-data
    driver: local
  mentor-logs:
    name: mentor-logs
    driver: local