# =============================================================================
# MENTOR SERVICE - PostgreSQL Configuration (Updated)
# =============================================================================
#
# CHANGES FROM ORIGINAL:
# - MySQL â†’ PostgreSQL (as per guidelines)
# - Added proper connection pooling
# - Configured for both dev and prod environments
# - Added Flyway migrations support
#
# Author: Douglas Kings Kato
# Version: 2.0.0
# =============================================================================

spring:
  application:
    name: mentor-service

  # =============================================================================
  # PROFILES CONFIGURATION
  # =============================================================================
  profiles:
    active: ${SPRING_PROFILES_ACTIVE:dev}

  # =============================================================================
  # DATABASE CONFIGURATION - POSTGRESQL
  # =============================================================================
  datasource:
    # PostgreSQL connection URL
    # Format: jdbc:postgresql://host:port/database?params
    url: jdbc:postgresql://${DB_HOST:localhost}:${DB_PORT:5432}/${DB_NAME:youthconnect_db}?currentSchema=public&ssl=false

    # Database credentials (externalize in production)
    username: ${DB_USERNAME:postgres}
    password: ${DB_PASSWORD:postgres}

    # PostgreSQL driver
    driver-class-name: org.postgresql.Driver

    # =============================================================================
    # HIKARICP CONNECTION POOL CONFIGURATION
    # =============================================================================
    hikari:
      # Maximum number of connections in the pool
      maximum-pool-size: ${DB_POOL_SIZE:20}

      # Minimum number of idle connections
      minimum-idle: ${DB_POOL_MIN_IDLE:5}

      # Maximum time connection can sit idle (5 minutes)
      idle-timeout: 300000

      # Maximum lifetime of connection in pool (30 minutes)
      max-lifetime: 1800000

      # Maximum time to wait for connection from pool (20 seconds)
      connection-timeout: 20000

      # Connection test query
      connection-test-query: SELECT 1

      # Pool name for monitoring/logging
      pool-name: MentorServiceHikariPool

  # =============================================================================
  # JPA/HIBERNATE CONFIGURATION - POSTGRESQL
  # =============================================================================
  jpa:
    # PostgreSQL dialect
    database-platform: org.hibernate.dialect.PostgreSQLDialect

    # Show SQL queries (disable in production)
    show-sql: ${JPA_SHOW_SQL:false}

    # Hibernate properties
    properties:
      hibernate:
        # Format SQL for readability
        format_sql: true

        # Use JDBC batching for bulk operations
        jdbc:
          batch_size: 20

        # Second-level cache
        cache:
          use_second_level_cache: true
          region:
            factory_class: org.hibernate.cache.jcache.JCacheRegionFactory

        # Query plan cache
        query:
          plan_cache_max_size: 2048

        # Default schema
        default_schema: public

    # Schema generation strategy
    # Options: none, validate, update, create, create-drop
    # Production should use 'validate' with Flyway for migrations
    hibernate:
      ddl-auto: ${JPA_DDL_AUTO:validate}

  # =============================================================================
  # FLYWAY DATABASE MIGRATION - POSTGRESQL
  # =============================================================================
  flyway:
    enabled: true
    # Location of migration scripts
    locations: classpath:db/migration
    # Baseline on migrate for existing databases
    baseline-on-migrate: true
    # Validate migrations on startup
    validate-on-migrate: true
    # PostgreSQL schema
    schemas: public
    # Create schema if doesn't exist
    create-schemas: true

  # =============================================================================
  # CACHING CONFIGURATION
  # =============================================================================
  cache:
    type: caffeine
    cache-names:
      - mentors
      - sessions
      - availability
      - reviews
      - statistics
    caffeine:
      spec: maximumSize=1000,expireAfterWrite=30m

# =============================================================================
# SERVER CONFIGURATION
# =============================================================================
server:
  port: ${SERVER_PORT:8090}

  servlet:
    context-path: /
    encoding:
      charset: UTF-8
      enabled: true
      force: true

  error:
    include-message: always
    include-binding-errors: always
    include-stacktrace: on_param
    include-exception: false

  connection-timeout: 20000

  compression:
    enabled: true
    mime-types: text/html,text/xml,text/plain,text/css,text/javascript,application/javascript,application/json
    min-response-size: 1024

# =============================================================================
# EUREKA CLIENT CONFIGURATION
# =============================================================================
eureka:
  client:
    register-with-eureka: true
    fetch-registry: true
    service-url:
      defaultZone: ${EUREKA_URI:http://localhost:8761/eureka/}
    registry-fetch-interval-seconds: 30

  instance:
    instance-id: ${spring.application.name}:${random.value}
    prefer-ip-address: true
    lease-renewal-interval-in-seconds: 30
    lease-expiration-duration-in-seconds: 90
    health-check-url-path: /actuator/health
    status-page-url-path: /actuator/info
    metadata-map:
      version: ${project.version:1.0.0}
      environment: ${spring.profiles.active}

# =============================================================================
# FEIGN CLIENT CONFIGURATION
# =============================================================================
feign:
  client:
    config:
      default:
        connect-timeout: 5000
        read-timeout: 10000
        logger-level: BASIC

      user-service:
        url: ${USER_SERVICE_URL:http://user-service}

      notification-service:
        url: ${NOTIFICATION_SERVICE_URL:http://notification-service}

  circuitbreaker:
    enabled: true

# =============================================================================
# RESILIENCE4J CIRCUIT BREAKER
# =============================================================================
resilience4j:
  circuitbreaker:
    instances:
      user-service:
        sliding-window-size: 10
        minimum-number-of-calls: 5
        failure-rate-threshold: 50
        wait-duration-in-open-state: 10000
        permitted-number-of-calls-in-half-open-state: 3
        automatic-transition-from-open-to-half-open-enabled: true

      notification-service:
        sliding-window-size: 10
        minimum-number-of-calls: 5
        failure-rate-threshold: 50
        wait-duration-in-open-state: 10000
        permitted-number-of-calls-in-half-open-state: 3
        automatic-transition-from-open-to-half-open-enabled: true

# =============================================================================
# SPRING BOOT ACTUATOR
# =============================================================================
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus,env,loggers
      base-path: /actuator

  endpoint:
    health:
      show-details: when-authorized
      diskspace:
        enabled: true
        threshold: 10MB

  metrics:
    export:
      prometheus:
        enabled: true
    enable:
      jvm: true
      process: true
      system: true

  info:
    build:
      enabled: true
    git:
      enabled: true
      mode: full

# =============================================================================
# LOGGING CONFIGURATION
# =============================================================================
logging:
  level:
    root: INFO
    com.youthconnect.mentor_service: ${LOG_LEVEL:DEBUG}
    org.springframework: INFO
    org.springframework.web: ${WEB_LOG_LEVEL:INFO}
    org.hibernate: WARN
    org.hibernate.SQL: ${SQL_LOG_LEVEL:DEBUG}
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE
    feign: DEBUG
    com.zaxxer.hikari: INFO
    org.postgresql: INFO

  file:
    name: ${LOG_FILE:logs/mentor-service.log}
    max-size: 10MB
    max-history: 30

  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"

# =============================================================================
# SPRINGDOC OPENAPI (SWAGGER) CONFIGURATION
# =============================================================================
springdoc:
  api-docs:
    enabled: true
    path: /api-docs

  swagger-ui:
    enabled: true
    path: /swagger-ui.html
    operations-sorter: method
    tags-sorter: alpha
    try-it-out-enabled: true

  packages-to-scan: com.youthconnect.mentor_service.controller
  show-actuator: false

# =============================================================================
# CUSTOM APPLICATION PROPERTIES
# =============================================================================
app:
  mentorship:
    default-session-duration: 60
    max-sessions-per-week: 10
    min-session-gap: 30
    reminder-times:
      - 24
      - 1
    auto-cancel-threshold: 24

  reviews:
    min-rating: 1
    max-rating: 5
    moderation-enabled: true
    min-comment-length: 10
    max-comment-length: 500

  matching:
    min-match-score: 60
    weights:
      expertise: 0.4
      rating: 0.3
      availability: 0.2
      location: 0.1

  cache:
    ttl:
      mentors: 1800
      sessions: 300
      availability: 600
      reviews: 3600
      statistics: 1800

  features:
    video-calls-enabled: ${VIDEO_CALLS_ENABLED:false}
    calendar-integration-enabled: ${CALENDAR_INTEGRATION_ENABLED:false}
    ai-matching-enabled: ${AI_MATCHING_ENABLED:true}
    auto-reminders-enabled: ${AUTO_REMINDERS_ENABLED:true}