<?xml version="1.0" encoding="UTF-8"?>
<!--
    ═══════════════════════════════════════════════════════════════════════════
    LOGBACK CONFIGURATION FOR MENTOR SERVICE
    ═══════════════════════════════════════════════════════════════════════════

    Features:
    - Environment-specific logging (dev, staging, prod)
    - Console and file appenders
    - Async logging for performance
    - JSON formatting for production (ELK stack ready)
    - Rolling file policy with compression
    - Structured logging with MDC context

    Author: Douglas Kings Kato
    Version: 1.0.0
    Date: 2025-11-06
    ═══════════════════════════════════════════════════════════════════════════
-->
<configuration>

    <!-- ═══════════════════════════════════════════════════════════════════ -->
    <!-- PROPERTIES AND VARIABLES                                             -->
    <!-- ═══════════════════════════════════════════════════════════════════ -->

    <!-- Service name for identification -->
    <property name="SERVICE_NAME" value="mentor-service"/>

    <!-- Log directory (can be overridden by environment variable) -->
    <property name="LOG_PATH" value="${LOG_PATH:-logs}"/>

    <!-- Log file name pattern -->
    <property name="LOG_FILE" value="${LOG_PATH}/${SERVICE_NAME}"/>

    <!-- Console log pattern (human-readable for development) -->
    <property name="CONSOLE_LOG_PATTERN"
              value="%d{yyyy-MM-dd HH:mm:ss.SSS} %highlight(%-5level) [%thread] %cyan(%logger{36}) - %msg%n"/>

    <!-- File log pattern (detailed for production) -->
    <property name="FILE_LOG_PATTERN"
              value="%d{yyyy-MM-dd HH:mm:ss.SSS} %-5level [%thread] %logger{36} - %msg %n"/>

    <!-- Max file size before rolling -->
    <property name="MAX_FILE_SIZE" value="10MB"/>

    <!-- Max history (days to keep logs) -->
    <property name="MAX_HISTORY" value="30"/>

    <!-- Total size cap for all log files -->
    <property name="TOTAL_SIZE_CAP" value="1GB"/>

    <!-- ═══════════════════════════════════════════════════════════════════ -->
    <!-- CONSOLE APPENDER (STDOUT)                                            -->
    <!-- ═══════════════════════════════════════════════════════════════════ -->

    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>${CONSOLE_LOG_PATTERN}</pattern>
            <charset>UTF-8</charset>
        </encoder>

        <!-- Only log INFO and above to console -->
        <filter class="ch.qos.logback.classic.filter.ThresholdFilter">
            <level>INFO</level>
        </filter>
    </appender>

    <!-- ═══════════════════════════════════════════════════════════════════ -->
    <!-- FILE APPENDER (ROLLING)                                              -->
    <!-- ═══════════════════════════════════════════════════════════════════ -->

    <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <!-- Current log file -->
        <file>${LOG_FILE}.log</file>

        <!-- Encoder -->
        <encoder>
            <pattern>${FILE_LOG_PATTERN}</pattern>
            <charset>UTF-8</charset>
        </encoder>

        <!-- Rolling policy (time and size based) -->
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <!-- Rollover daily and when file size exceeds limit -->
            <fileNamePattern>${LOG_FILE}-%d{yyyy-MM-dd}.%i.log.gz</fileNamePattern>
            <maxFileSize>${MAX_FILE_SIZE}</maxFileSize>
            <maxHistory>${MAX_HISTORY}</maxHistory>
            <totalSizeCap>${TOTAL_SIZE_CAP}</totalSizeCap>
            <cleanHistoryOnStart>false</cleanHistoryOnStart>
        </rollingPolicy>

        <!-- Immediate flush (ensure logs are written) -->
        <immediateFlush>true</immediateFlush>
    </appender>

    <!-- ═══════════════════════════════════════════════════════════════════ -->
    <!-- ERROR FILE APPENDER (SEPARATE ERROR LOG)                             -->
    <!-- ═══════════════════════════════════════════════════════════════════ -->

    <appender name="ERROR_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <!-- Current error log file -->
        <file>${LOG_FILE}-error.log</file>

        <!-- Encoder -->
        <encoder>
            <pattern>${FILE_LOG_PATTERN}</pattern>
            <charset>UTF-8</charset>
        </encoder>

        <!-- Rolling policy -->
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <fileNamePattern>${LOG_FILE}-error-%d{yyyy-MM-dd}.%i.log.gz</fileNamePattern>
            <maxFileSize>${MAX_FILE_SIZE}</maxFileSize>
            <maxHistory>${MAX_HISTORY}</maxHistory>
            <totalSizeCap>500MB</totalSizeCap>
        </rollingPolicy>

        <!-- Only ERROR and above -->
        <filter class="ch.qos.logback.classic.filter.ThresholdFilter">
            <level>ERROR</level>
        </filter>

        <immediateFlush>true</immediateFlush>
    </appender>

    <!-- ═══════════════════════════════════════════════════════════════════ -->
    <!-- ASYNC APPENDERS (FOR PERFORMANCE)                                    -->
    <!-- ═══════════════════════════════════════════════════════════════════ -->

    <!-- Async console appender -->
    <appender name="ASYNC_CONSOLE" class="ch.qos.logback.classic.AsyncAppender">
        <appender-ref ref="CONSOLE"/>
        <queueSize>512</queueSize>
        <discardingThreshold>0</discardingThreshold>
        <includeCallerData>false</includeCallerData>
    </appender>

    <!-- Async file appender -->
    <appender name="ASYNC_FILE" class="ch.qos.logback.classic.AsyncAppender">
        <appender-ref ref="FILE"/>
        <queueSize>512</queueSize>
        <discardingThreshold>0</discardingThreshold>
        <includeCallerData>false</includeCallerData>
    </appender>

    <!-- Async error file appender -->
    <appender name="ASYNC_ERROR_FILE" class="ch.qos.logback.classic.AsyncAppender">
        <appender-ref ref="ERROR_FILE"/>
        <queueSize>256</queueSize>
        <discardingThreshold>0</discardingThreshold>
        <includeCallerData>true</includeCallerData>
    </appender>

    <!-- ═══════════════════════════════════════════════════════════════════ -->
    <!-- JSON APPENDER (FOR PRODUCTION/ELK STACK)                             -->
    <!-- ═══════════════════════════════════════════════════════════════════ -->

    <springProfile name="prod">
        <appender name="JSON_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
            <file>${LOG_FILE}-json.log</file>

            <!-- JSON encoder (requires logstash-logback-encoder dependency) -->
            <encoder class="net.logstash.logback.encoder.LogstashEncoder">
                <includeMdc>true</includeMdc>
                <includeContext>true</includeContext>
                <includeCallerData>false</includeCallerData>

                <!-- Custom fields -->
                <customFields>{"service":"${SERVICE_NAME}","environment":"production"}</customFields>
            </encoder>

            <!-- Rolling policy -->
            <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
                <fileNamePattern>${LOG_FILE}-json-%d{yyyy-MM-dd}.%i.log.gz</fileNamePattern>
                <maxFileSize>${MAX_FILE_SIZE}</maxFileSize>
                <maxHistory>${MAX_HISTORY}</maxHistory>
                <totalSizeCap>${TOTAL_SIZE_CAP}</totalSizeCap>
            </rollingPolicy>
        </appender>

        <!-- Async JSON appender -->
        <appender name="ASYNC_JSON" class="ch.qos.logback.classic.AsyncAppender">
            <appender-ref ref="JSON_FILE"/>
            <queueSize>512</queueSize>
        </appender>
    </springProfile>

    <!-- ═══════════════════════════════════════════════════════════════════ -->
    <!-- LOGGER CONFIGURATIONS                                                 -->
    <!-- ═══════════════════════════════════════════════════════════════════ -->

    <!-- Application loggers -->
    <logger name="com.youthconnect.mentor_service" level="DEBUG" additivity="false">
        <appender-ref ref="ASYNC_CONSOLE"/>
        <appender-ref ref="ASYNC_FILE"/>
        <appender-ref ref="ASYNC_ERROR_FILE"/>
    </logger>

    <!-- Spring Framework -->
    <logger name="org.springframework" level="INFO" additivity="false">
        <appender-ref ref="ASYNC_CONSOLE"/>
        <appender-ref ref="ASYNC_FILE"/>
    </logger>

    <!-- Spring Web (detailed for debugging) -->
    <springProfile name="dev">
        <logger name="org.springframework.web" level="DEBUG" additivity="false">
            <appender-ref ref="ASYNC_CONSOLE"/>
            <appender-ref ref="ASYNC_FILE"/>
        </logger>
    </springProfile>

    <springProfile name="!dev">
        <logger name="org.springframework.web" level="INFO" additivity="false">
            <appender-ref ref="ASYNC_FILE"/>
        </logger>
    </springProfile>

    <!-- Hibernate/JPA -->
    <logger name="org.hibernate" level="WARN" additivity="false">
        <appender-ref ref="ASYNC_FILE"/>
    </logger>

    <!-- SQL logging (only in dev) -->
    <springProfile name="dev">
        <logger name="org.hibernate.SQL" level="DEBUG" additivity="false">
            <appender-ref ref="ASYNC_CONSOLE"/>
            <appender-ref ref="ASYNC_FILE"/>
        </logger>

        <logger name="org.hibernate.type.descriptor.sql.BasicBinder" level="TRACE" additivity="false">
            <appender-ref ref="ASYNC_FILE"/>
        </logger>
    </springProfile>

    <!-- PostgreSQL Driver -->
    <logger name="org.postgresql" level="INFO" additivity="false">
        <appender-ref ref="ASYNC_FILE"/>
    </logger>

    <!-- HikariCP (Connection Pool) -->
    <logger name="com.zaxxer.hikari" level="INFO" additivity="false">
        <appender-ref ref="ASYNC_FILE"/>
    </logger>

    <!-- Feign Client -->
    <logger name="feign" level="DEBUG" additivity="false">
        <appender-ref ref="ASYNC_CONSOLE"/>
        <appender-ref ref="ASYNC_FILE"/>
    </logger>

    <!-- Eureka Client -->
    <logger name="com.netflix.discovery" level="INFO" additivity="false">
        <appender-ref ref="ASYNC_FILE"/>
    </logger>

    <!-- Security (Spring Security) -->
    <logger name="org.springframework.security" level="DEBUG" additivity="false">
        <appender-ref ref="ASYNC_CONSOLE"/>
        <appender-ref ref="ASYNC_FILE"/>
    </logger>

    <!-- Cache operations -->
    <logger name="org.springframework.cache" level="DEBUG" additivity="false">
        <appender-ref ref="ASYNC_FILE"/>
    </logger>

    <!-- Validation errors -->
    <logger name="org.springframework.validation" level="DEBUG" additivity="false">
        <appender-ref ref="ASYNC_CONSOLE"/>
        <appender-ref ref="ASYNC_FILE"/>
    </logger>

    <!-- ═══════════════════════════════════════════════════════════════════ -->
    <!-- ROOT LOGGER                                                           -->
    <!-- ═══════════════════════════════════════════════════════════════════ -->

    <!-- Development profile (verbose) -->
    <springProfile name="dev">
        <root level="INFO">
            <appender-ref ref="ASYNC_CONSOLE"/>
            <appender-ref ref="ASYNC_FILE"/>
            <appender-ref ref="ASYNC_ERROR_FILE"/>
        </root>
    </springProfile>

    <!-- Staging profile (moderate) -->
    <springProfile name="staging">
        <root level="INFO">
            <appender-ref ref="ASYNC_FILE"/>
            <appender-ref ref="ASYNC_ERROR_FILE"/>
        </root>
    </springProfile>

    <!-- Production profile (minimal + JSON) -->
    <springProfile name="prod">
        <root level="WARN">
            <appender-ref ref="ASYNC_FILE"/>
            <appender-ref ref="ASYNC_ERROR_FILE"/>
            <appender-ref ref="ASYNC_JSON"/>
        </root>
    </springProfile>

    <!-- ═══════════════════════════════════════════════════════════════════ -->
    <!-- SHUTDOWN HOOK                                                         -->
    <!-- ═══════════════════════════════════════════════════════════════════ -->

    <!-- Ensure async appenders flush on shutdown -->
    <shutdownHook class="ch.qos.logback.core.hook.DelayingShutdownHook"/>

</configuration>