# ═══════════════════════════════════════════════════════════════════════════
# NOTIFICATION SERVICE - Complete Production Configuration
# Location: notification-service/src/main/resources/application.yml
# ═══════════════════════════════════════════════════════════════════════════

spring:
  application:
    name: notification-service

  # ═════════════════════════════════════════════════════════════════════════
  # DATABASE CONFIGURATION
  # ═════════════════════════════════════════════════════════════════════════
  datasource:
    url: jdbc:mysql://localhost:3307/youth_connect_db?useSSL=false&serverTimezone=Africa/Kampala&allowPublicKeyRetrieval=true
    username: root
    password: ${DB_PASSWORD:root}
    driver-class-name: com.mysql.cj.jdbc.Driver

    # HikariCP Connection Pool Configuration
    hikari:
      maximum-pool-size: 10        # Max database connections
      minimum-idle: 2               # Min idle connections
      connection-timeout: 30000     # 30 seconds
      idle-timeout: 600000          # 10 minutes
      max-lifetime: 1800000         # 30 minutes
      pool-name: NotificationServicePool

  # ═════════════════════════════════════════════════════════════════════════
  # JPA / HIBERNATE CONFIGURATION
  # ═════════════════════════════════════════════════════════════════════════
  jpa:
    hibernate:
      ddl-auto: validate   # NEVER use "update" in production - use Flyway
    show-sql: false        # Disable SQL logging in production
    properties:
      hibernate:
        format_sql: true
        dialect: org.hibernate.dialect.MySQL8Dialect
        use_sql_comments: true
        jdbc:
          batch_size: 20   # Batch insert optimization
        order_inserts: true
        order_updates: true

  # ═════════════════════════════════════════════════════════════════════════
  # EMAIL CONFIGURATION (SMTP)
  # ═════════════════════════════════════════════════════════════════════════
  mail:
    host: ${SMTP_HOST:smtp.gmail.com}
    port: ${SMTP_PORT:587}
    username: ${EMAIL_USERNAME:noreply@youthconnect.ug}
    password: ${EMAIL_PASSWORD:your_app_password}

    properties:
      mail:
        smtp:
          auth: true
          starttls:
            enable: true
            required: true
          connectiontimeout: 5000
          timeout: 5000
          writetimeout: 5000
          ssl:
            trust: smtp.gmail.com  # Trust Gmail's SSL certificate
        debug: false  # Set to true for email debugging

    # Email Template Configuration
    template:
      prefix: classpath:/templates/
      suffix: .html
      encoding: UTF-8

  # ═════════════════════════════════════════════════════════════════════════
  # REDIS CONFIGURATION
  # ═════════════════════════════════════════════════════════════════════════
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}  # Empty for local, set in production
      database: 0

      # Lettuce Client Configuration (Async, High Performance)
      lettuce:
        pool:
          max-active: 8       # Max connections
          max-idle: 8         # Max idle connections
          min-idle: 2         # Min idle connections
          max-wait: -1ms      # Wait indefinitely for connection
        shutdown-timeout: 100ms

      # Redis Timeouts
      timeout: 3000ms         # Connection timeout
      connect-timeout: 3000ms

  # ═════════════════════════════════════════════════════════════════════════
  # CACHE CONFIGURATION
  # ═════════════════════════════════════════════════════════════════════════
  cache:
    type: redis
    redis:
      time-to-live: 3600000   # 1 hour default TTL
      cache-null-values: false
      key-prefix: "notification::"

# ═══════════════════════════════════════════════════════════════════════════
# SERVER CONFIGURATION
# ═══════════════════════════════════════════════════════════════════════════
server:
  port: 7077
  compression:
    enabled: true
    mime-types: application/json,application/xml,text/html,text/xml,text/plain

  # Thread Pool Configuration
  tomcat:
    threads:
      max: 200              # Max concurrent requests
      min-spare: 10         # Min threads alive
    max-connections: 10000  # Max TCP connections
    accept-count: 100       # Connection queue size

# ═══════════════════════════════════════════════════════════════════════════
# EUREKA CLIENT CONFIGURATION
# ═══════════════════════════════════════════════════════════════════════════
eureka:
  client:
    service-url:
      defaultZone: ${EUREKA_SERVER_URL:http://localhost:8761/eureka/}
    fetch-registry: true
    register-with-eureka: true
    registry-fetch-interval-seconds: 30

  instance:
    prefer-ip-address: true
    instance-id: ${spring.application.name}:${random.value}
    lease-renewal-interval-in-seconds: 30
    lease-expiration-duration-in-seconds: 90

    # Health Check Configuration
    health-check-url-path: /actuator/health
    status-page-url-path: /actuator/info

# ═══════════════════════════════════════════════════════════════════════════
# AFRICA'S TALKING SMS CONFIGURATION
# ═══════════════════════════════════════════════════════════════════════════
africas-talking:
  api-key: ${AFRICAS_TALKING_API_KEY:your_api_key_here}
  username: ${AFRICAS_TALKING_USERNAME:sandbox}
  base-url: https://api.africastalking.com/version1
  sender-id: ${SENDER_ID:YouthConnect}  # Approved sender ID

# ═══════════════════════════════════════════════════════════════════════════
# FIREBASE PUSH NOTIFICATION CONFIGURATION
# ═══════════════════════════════════════════════════════════════════════════
firebase:
  service-account-file: ${FIREBASE_SERVICE_ACCOUNT:firebase-service-account.json}
  project-id: ${FIREBASE_PROJECT_ID:kwetu-hub-uganda}
  database-url: ${FIREBASE_DB_URL:https://kwetu-hub-uganda.firebaseio.com}

# ═══════════════════════════════════════════════════════════════════════════
# APPLICATION CUSTOM CONFIGURATION
# ═══════════════════════════════════════════════════════════════════════════
app:
  notification:
    retry-attempts: 3       # Max retry attempts for failed notifications
    batch-size: 100         # Batch processing size
    rate-limit: 1000        # Max notifications per hour per user

    # SMS Configuration
    sms:
      max-length: 160       # Single SMS character limit
      concatenated-max: 306 # Concatenated SMS limit

    # Email Configuration
    email:
      from-name: "Kwetu-Hub Uganda"
      from-address: ${EMAIL_USERNAME:noreply@youthconnect.ug}
      reply-to: support@youthconnect.ug

    # Push Notification Configuration
    push:
      android-priority: HIGH
      ios-priority: 10
      ttl-seconds: 86400    # 24 hours

  # Web Application URL (for email links)
  web-url: ${WEB_APP_URL:https://kwetuhub.ug}

# ═══════════════════════════════════════════════════════════════════════════
# LOGGING CONFIGURATION
# ═══════════════════════════════════════════════════════════════════════════
logging:
  level:
    root: INFO
    com.youthconnect.notification.service: DEBUG
    org.springframework.mail: DEBUG
    org.springframework.data.redis: INFO
    org.hibernate.SQL: DEBUG
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE

  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"

  file:
    name: logs/notification-service.log
    max-size: 10MB
    max-history: 30

# ═══════════════════════════════════════════════════════════════════════════
# ACTUATOR CONFIGURATION (Monitoring & Health Checks)
# ═══════════════════════════════════════════════════════════════════════════
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
      base-path: /actuator

  endpoint:
    health:
      show-details: always
      probes:
        enabled: true

  health:
    redis:
      enabled: true
    mail:
      enabled: true
    db:
      enabled: true

  metrics:
    export:
      prometheus:
        enabled: true
    tags:
      application: ${spring.application.name}

# ═══════════════════════════════════════════════════════════════════════════
# ASYNC PROCESSING CONFIGURATION
# ═══════════════════════════════════════════════════════════════════════════
async:
  core-pool-size: 10
  max-pool-size: 50
  queue-capacity: 1000
  thread-name-prefix: "notification-async-"