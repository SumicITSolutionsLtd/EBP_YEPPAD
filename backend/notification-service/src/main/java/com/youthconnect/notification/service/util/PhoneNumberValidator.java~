package com.youthconnect.notification.service.util;

import lombok.extern.slf4j.Slf4j;

import java.util.regex.Pattern;

/**
 * ═══════════════════════════════════════════════════════════════════════════
 * UGANDA PHONE NUMBER VALIDATOR & FORMATTER
 * ═══════════════════════════════════════════════════════════════════════════
 *
 * Validates and formats Ugandan mobile phone numbers for SMS delivery.
 *
 * **Uganda Phone Number Format:**
 * - Country Code: +256
 * - Mobile Operators:
 *   - MTN: 077x, 078x, 039x
 *   - Airtel: 070x, 075x
 *   - Africell: 079x
 * - Total Digits: 12 (including country code)
 * - Format: +256XXXXXXXXX
 *
 * **Accepted Input Formats:**
 * - International: +256701234567
 * - Local: 0701234567
 * - Without prefix: 701234567
 *
 * **Output Format:**
 * - Always returns: +256XXXXXXXXX
 *
 * **Usage Example:**
 * <pre>
 * // Validation
 * boolean isValid = PhoneNumberValidator.isValidUgandaPhone("0701234567");
 *
 * // Formatting
 * String formatted = PhoneNumberValidator.formatToInternational("0701234567");
 * // Returns: "+256701234567"
 *
 * // Extraction
 * String operator = PhoneNumberValidator.getOperator("+256701234567");
 * // Returns: "Airtel"
 * </pre>
 *
 * @author Douglas Kings Kato
 * @version 1.0
 * @since 2025-01-20
 */
@Slf4j
public class PhoneNumberValidator {

    // ═══════════════════════════════════════════════════════════════════════
    // CONSTANTS
    // ═══════════════════════════════════════════════════════════════════════

    /**
     * Uganda country code.
     */
    private static final String UGANDA_COUNTRY_CODE = "256";

    /**
     * Uganda country code with plus sign.
     */
    private static final String UGANDA_CODE_WITH_PLUS = "+256";

    /**
     * Total length of Uganda phone number (including country code).
     * Format: +256XXXXXXXXX = 13 characters
     */
    private static final int FULL_LENGTH_WITH_PLUS = 13;

    /**
     * Total length without plus sign.
     * Format: 256XXXXXXXXX = 12 characters
     */
    private static final int FULL_LENGTH_WITHOUT_PLUS = 12;

    /**
     * Length of local format phone number.
     * Format: 0XXXXXXXXX = 10 characters
     */
    private static final int LOCAL_FORMAT_LENGTH = 10;

    /**
     * Length of phone number without prefix (local or country code).
     * Format: XXXXXXXXX = 9 characters
     */
    private static final int WITHOUT_PREFIX_LENGTH = 9;

    // ═══════════════════════════════════════════════════════════════════════
    // REGEX PATTERNS
    // ═══════════════════════════════════════════════════════════════════════

    /**
     * Pattern for international format with plus.
     * Example: +256701234567
     */
    private static final Pattern INTERNATIONAL_WITH_PLUS = Pattern.compile(
            "^\\+256[0-9]{9}$"
    );

    /**
     * Pattern for international format without plus.
     * Example: 256701234567
     */
    private static final Pattern INTERNATIONAL_WITHOUT_PLUS = Pattern.compile(
            "^256[0-9]{9}$"
    );

    /**
     * Pattern for local format starting with 0.
     * Example: 0701234567
     */
    private static final Pattern LOCAL_FORMAT = Pattern.compile(
            "^0[7][0-9]{8}$"
    );

    /**
     * Pattern for format without any prefix.
     * Example: 701234567
     */
    private static final Pattern WITHOUT_PREFIX = Pattern.compile(
            "^[7][0-9]{8}$"
    );

    /**
     * Pattern for validating formatted Uganda phone numbers.
     * Must start with 07 (local format) or +2567 (international).
     */
    private static final Pattern VALID_UGANDA_PHONE = Pattern.compile(
            "^(\\+256|0)?7[0-9]{8}$"
    );

    // ═══════════════════════════════════════════════════════════════════════
    // MOBILE OPERATOR PREFIXES
    // ═══════════════════════════════════════════════════════════════════════

    /**
     * MTN Uganda prefixes (077, 078, 039).
     */
    private static final Pattern MTN_PATTERN = Pattern.compile("^(077|078|039)");

    /**
     * Airtel Uganda prefixes (070, 075).
     */
    private static final Pattern AIRTEL_PATTERN = Pattern.compile("^(070|075)");

    /**
     * Africell Uganda prefix (079).
     */
    private static final Pattern AFRICELL_PATTERN = Pattern.compile("^079");

    // ═══════════════════════════════════════════════════════════════════════
    // VALIDATION METHODS
    // ═══════════════════════════════════════════════════════════════════════

    /**
     * Validate if a phone number is a valid Ugandan mobile number.
     *
     * Accepts formats:
     * - +256701234567
     * - 256701234567
     * - 0701234567
     * - 701234567
     *
     * @param phoneNumber Phone number to validate
     * @return true if valid Uganda phone number
     */
    public static boolean isValidUgandaPhone(String phoneNumber) {
        if (phoneNumber == null || phoneNumber.isBlank()) {
            log.debug("❌ Phone validation failed: null or blank");
            return false;
        }

        // Remove all non-numeric characters except +
        String cleaned = phoneNumber.replaceAll("[^+0-9]", "");

        log.debug("🔍 Validating phone: original={}, cleaned={}", phoneNumber, cleaned);

        // Check against all accepted patterns
        boolean isValid = INTERNATIONAL_WITH_PLUS.matcher(cleaned).matches() ||
                INTERNATIONAL_WITHOUT_PLUS.matcher(cleaned).matches() ||
                LOCAL_FORMAT.matcher(cleaned).matches() ||
                WITHOUT_PREFIX.matcher(cleaned).matches();

        log.debug("✅ Phone validation result: {} → {}", cleaned, isValid);

        return isValid;
    }

    /**
     * Check if phone number starts with valid Ugandan mobile prefix (07x).
     *
     * @param phoneNumber Phone number to check
     * @return true if starts with 07x prefix
     */
    public static boolean hasValidMobilePrefix(String phoneNumber) {
        String cleaned = cleanPhoneNumber(phoneNumber);

        // Convert to local format for prefix checking
        String localFormat = toLocalFormat(cleaned);

        return localFormat != null && localFormat.startsWith("07");
    }

    // ═══════════════════════════════════════════════════════════════════════
    // FORMATTING METHODS
    // ═══════════════════════════════════════════════════════════════════════

    /**
     * Format phone number to international format (+256XXXXXXXXX).
     *
     * Converts any valid format to: +256701234567
     *
     * @param phoneNumber Phone number in any valid format
     * @return Formatted phone number with +256 prefix
     * @throws IllegalArgumentException if phone number is invalid
     */
    public static String formatToInternational(String phoneNumber) {
        if (!isValidUgandaPhone(phoneNumber)) {
            throw new IllegalArgumentException(
                    "Invalid Uganda phone number format: " + phoneNumber
            );
        }

        String cleaned = cleanPhoneNumber(phoneNumber);

        // Already in international format with +
        if (cleaned.startsWith("+256")) {
            return cleaned;
        }

        // International format without +
        if (cleaned.startsWith("256")) {
            return "+" + cleaned;
        }

        // Local format with 0
        if (cleaned.startsWith("0")) {
            return "+256" + cleaned.substring(1);
        }

        // Without any prefix
        return "+256" + cleaned;
    }

    /**
     * Format phone number to local format (0XXXXXXXXX).
     *
     * Converts any valid format to: 0701234567
     *
     * @param phoneNumber Phone number in any valid format
     * @return Formatted phone number with 0 prefix
     * @throws IllegalArgumentException if phone number is invalid
     */
    public static String formatToLocal(String phoneNumber) {
        if (!isValidUgandaPhone(phoneNumber)) {
            throw new IllegalArgumentException(
                    "Invalid Uganda phone number format: " + phoneNumber
            );
        }

        String cleaned = cleanPhoneNumber(phoneNumber);

        // Already in local format
        if (cleaned.startsWith("0")) {
            return cleaned;
        }

        // International format with +256
        if (cleaned.startsWith("+256")) {
            return "0" + cleaned.substring(4);
        }

        // International format without +
        if (cleaned.startsWith("256")) {
            return "0" + cleaned.substring(3);
        }

        // Without any prefix
        return "0" + cleaned;
    }

    /**
     * Convert phone number to local format (private helper).
     *
     * @param cleaned Already cleaned phone number
     * @return Local format or null if invalid
     */
    private static String toLocalFormat(String cleaned) {
        try {
            if (cleaned.startsWith("0")) {
                return cleaned;
            }
            if (cleaned.startsWith("+256")) {
                return "0" + cleaned.substring(4);
            }
            if (cleaned.startsWith("256")) {
                return "0" + cleaned.substring(3);
            }
            return "0" + cleaned;
        } catch (Exception e) {
            return null;
        }
    }

/**
 * Clean phone number by
}
