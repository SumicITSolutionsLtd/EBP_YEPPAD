# =================================================================================
# Youth Connect Uganda - Auth Service Configuration
# Production & Development Profiles
# =================================================================================

spring:
  application:
    name: auth-service

  # -----------------------------------------------------------------------------
  # Database Configuration (MySQL + HikariCP)
  # -----------------------------------------------------------------------------
  datasource:
    url: jdbc:mysql://localhost:3307/youth_connect_db?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Africa/Nairobi&createDatabaseIfNotExist=true
    username: root
    password: Douglas20!
    driver-class-name: com.mysql.cj.jdbc.Driver
    hikari:
      pool-name: AuthServiceHikariPool
      maximum-pool-size: 10
      minimum-idle: 2
      idle-timeout: 300000
      max-lifetime: 1200000
      connection-timeout: 20000
      leak-detection-threshold: 60000

  # -----------------------------------------------------------------------------
  # JPA / Hibernate
  # -----------------------------------------------------------------------------
  jpa:
    hibernate:
      ddl-auto: validate   # use Flyway for migrations
    database-platform: org.hibernate.dialect.MySQL8Dialect
    show-sql: false
    properties:
      hibernate:
        format_sql: true
        jdbc:
          batch_size: 20
        order_inserts: true
        order_updates: true

  # -----------------------------------------------------------------------------
  # Flyway Database Migration
  # -----------------------------------------------------------------------------
  flyway:
    enabled: true
    baseline-on-migrate: true
    locations: classpath:db/migration
    validate-on-migrate: true

  # -----------------------------------------------------------------------------
  # Redis (token blacklist & caching)
  # -----------------------------------------------------------------------------
  data:
    redis:
      host: localhost
      port: 6379
      timeout: 2000ms
      jedis:
        pool:
          max-active: 20
          max-idle: 10
          min-idle: 2
          max-wait: -1ms

# -----------------------------------------------------------------------------
# Server Configuration
# -----------------------------------------------------------------------------
server:
  port: 8083
  servlet:
    context-path: /api/auth
  compression:
    enabled: true
  error:
    include-message: always
    include-binding-errors: always
    include-stacktrace: on_param

# -----------------------------------------------------------------------------
# JWT Security
# -----------------------------------------------------------------------------
jwt:
  secret: aVeryLongAndSecureSecretKeyForYouthConnectUgandaHackathonProjectWith256BitsMinimum
  expiration: 3600000        # 1 hour
  refresh-expiration: 604800000 # 7 days
  issuer: youth-connect-auth-service
  audience: youth-connect-platform

# -----------------------------------------------------------------------------
# Eureka Service Discovery
# -----------------------------------------------------------------------------
eureka:
  client:
    enabled: true
    register-with-eureka: true
    fetch-registry: true
    service-url:
      defaultZone: http://localhost:8761/eureka/
  instance:
    prefer-ip-address: true
    instance-id: ${spring.application.name}:${random.value}
    lease-renewal-interval-in-seconds: 30
    lease-expiration-duration-in-seconds: 90
    metadata-map:
      version: 1.0.0
      environment: ${app.environment:development}

# -----------------------------------------------------------------------------
# Feign Clients
# -----------------------------------------------------------------------------
feign:
  client:
    config:
      default:
        connectTimeout: 5000
        readTimeout: 10000
        loggerLevel: basic
  circuitbreaker:
    enabled: true

# -----------------------------------------------------------------------------
# Resilience4j Circuit Breakers & Retries
# -----------------------------------------------------------------------------
resilience4j:
  circuitbreaker:
    instances:
      userService:
        registerHealthIndicator: true
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        permittedNumberOfCallsInHalfOpenState: 3
        automaticTransitionFromOpenToHalfOpenEnabled: true
        waitDurationInOpenState: 10s
        failureRateThreshold: 50
      notificationService:
        registerHealthIndicator: true
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        permittedNumberOfCallsInHalfOpenState: 3
        waitDurationInOpenState: 15s
        failureRateThreshold: 60
  retry:
    instances:
      userService:
        maxAttempts: 3
        waitDuration: 500ms
        enableExponentialBackoff: true
        exponentialBackoffMultiplier: 2
      notificationService:
        maxAttempts: 2
        waitDuration: 1000ms

# -----------------------------------------------------------------------------
# Rate Limiting (per feature)
# -----------------------------------------------------------------------------
rate-limit:
  login:
    capacity: 5
    refill-tokens: 5
    refill-duration: 60
  register:
    capacity: 3
    refill-tokens: 3
    refill-duration: 300
  password-reset:
    capacity: 2
    refill-tokens: 2
    refill-duration: 600
  token-refresh:
    capacity: 10
    refill-tokens: 10
    refill-duration: 60

# -----------------------------------------------------------------------------
# Actuator & Monitoring
# -----------------------------------------------------------------------------
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
      base-path: /actuator
  endpoint:
    health:
      show-details: when-authorized
      probes:
        enabled: true
  metrics:
    export:
      prometheus:
        enabled: true
    tags:
      application: ${spring.application.name}
      environment: ${app.environment:development}

# -----------------------------------------------------------------------------
# API Documentation (OpenAPI / Swagger)
# -----------------------------------------------------------------------------
springdoc:
  api-docs:
    path: /api-docs
    enabled: true
  swagger-ui:
    path: /swagger-ui.html
    enabled: true
    tags-sorter: alpha
    operations-sorter: alpha
    display-request-duration: true
    doc-expansion: none
  show-actuator: true

# -----------------------------------------------------------------------------
# App-specific Configuration
# -----------------------------------------------------------------------------
app:
  name: Youth Connect Uganda Auth Service
  version: 1.0.0
  environment: development
  security:
    allowed-origins:
      - http://localhost:3000
      - http://localhost:3001
      - https://youthconnect.ug
      - https://www.youthconnect.ug
    password:
      min-length: 8
      require-uppercase: true
      require-lowercase: true
      require-digit: true
      require-special-char: true
      max-attempts: 5
      lockout-duration-minutes: 30
  token:
    blacklist-cleanup-cron: "0 0 2 * * ?" # cleanup at 2 AM daily
    max-refresh-count: 10
  ussd:
    session-timeout-minutes: 5
    default-language: en

# -----------------------------------------------------------------------------
# Logging
# -----------------------------------------------------------------------------
logging:
  level:
    root: INFO
    com.youthconnect.auth: DEBUG
    org.springframework.security: INFO
    org.springframework.web: INFO
    org.hibernate.SQL: WARN
    io.github.resilience4j: INFO
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} - %msg%n"
  file:
    name: logs/auth-service.log
    max-size: 10MB
    max-history: 30

# =================================================================================
# Profiles
# =================================================================================
---
spring.config.activate.on-profile: dev
logging.level:
  root: DEBUG
  org.springframework.web: DEBUG
  org.hibernate.SQL: DEBUG
  org.hibernate.type.descriptor.sql.BasicBinder: TRACE

---
spring.config.activate.on-profile: prod

spring:
  datasource:
    url: jdbc:mysql://${DB_HOST}:${DB_PORT}/${DB_NAME}?useSSL=true&serverTimezone=Africa/Nairobi
    username: ${DB_USER}
    password: ${DB_PASSWORD}
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5

jwt:
  secret: ${JWT_SECRET}  # override in production
logging.level:
  root: WARN
  com.youthconnect.auth: INFO
  org.springframework.web: WARN
