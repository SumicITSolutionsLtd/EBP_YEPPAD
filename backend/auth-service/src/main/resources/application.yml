# ═══════════════════════════════════════════════════════════════════════════
# Entrepreneurship Booster Platform - AUTH SERVICE CONFIGURATION (COMPLETE)
# ═══════════════════════════════════════════════════════════════════════════
# Service: auth-service
# Version: 2.0.0
# Author: Douglas Kings Kato
# Date: 2025-11-16
# ═══════════════════════════════════════════════════════════════════════════

# ═══════════════════════════════════════════════════════════════════════════
# SPRING CONFIGURATION
# ═══════════════════════════════════════════════════════════════════════════
spring:
  # Application Metadata
  application:
    name: auth-service
    description: Authentication and Authorization Service for Entrepreneurship Booster Platform
    version: '@project.version@'

  # ───────────────────────────────────────────────────────────────────────────
  # SECURITY CONFIGURATION (OAuth2 Client)
  # ───────────────────────────────────────────────────────────────────────────
  security:
    oauth2:
      client:
        registration:
          google:
            # ✅ FIXED: Default placeholder values prevent startup failures
            client-id: ${GOOGLE_CLIENT_ID:placeholder-client-id-not-configured}
            client-secret: ${GOOGLE_CLIENT_SECRET:placeholder-client-secret-not-configured}
            scope:
              - email
              - profile
              - openid
            authorization-grant-type: authorization_code
            client-authentication-method: client_secret_post
            redirect-uri: "{baseUrl}/login/oauth2/code/{registrationId}"

        provider:
          google:
            authorization-uri: https://accounts.google.com/o/oauth2/v2/auth
            token-uri: https://oauth2.googleapis.com/token
            user-info-uri: https://www.googleapis.com/oauth2/v3/userinfo
            user-name-attribute: sub
            issuer-uri: https://accounts.google.com

  # ───────────────────────────────────────────────────────────────────────────
  # DATABASE CONFIGURATION (PostgreSQL)
  # ───────────────────────────────────────────────────────────────────────────
  datasource:
    url: jdbc:postgresql://${DB_HOST:localhost}:${DB_PORT:5432}/${DB_NAME:youthconnect_auth}
    username: ${DB_USER:youthconnect_user}
    password: ${DB_PASSWORD:YouthConnect2024!}
    driver-class-name: org.postgresql.Driver

    hikari:
      maximum-pool-size: ${DB_POOL_SIZE:10}
      minimum-idle: ${DB_POOL_MIN_IDLE:2}
      connection-timeout: 30000
      max-lifetime: 1800000
      idle-timeout: 600000
      pool-name: AuthServiceHikariPool
      connection-test-query: SELECT 1
      auto-commit: true

  # ───────────────────────────────────────────────────────────────────────────
  # JPA/HIBERNATE CONFIGURATION
  # ───────────────────────────────────────────────────────────────────────────
  jpa:
    hibernate:
      ddl-auto: validate
    database-platform: org.hibernate.dialect.PostgreSQLDialect
    show-sql: ${SHOW_SQL:true}
    properties:
      hibernate:
        format_sql: true
        use_sql_comments: true
        jdbc:
          batch_size: 20
        cache:
          use_second_level_cache: false
        generate_statistics: ${HIBERNATE_STATS:false}

  # ───────────────────────────────────────────────────────────────────────────
  # FLYWAY DATABASE MIGRATION
  # ───────────────────────────────────────────────────────────────────────────
  flyway:
    enabled: true
    baseline-on-migrate: true
    baseline-version: 0
    locations: classpath:db/migration
    validate-on-migrate: true
    out-of-order: ${FLYWAY_OUT_OF_ORDER:false}
    table: flyway_schema_history
    sql-migration-prefix: V
    sql-migration-separator: __
    sql-migration-suffixes: .sql

  # ───────────────────────────────────────────────────────────────────────────
  # REDIS CONFIGURATION
  # ───────────────────────────────────────────────────────────────────────────
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      database: ${REDIS_DB:0}
      timeout: 3000ms
      lettuce:
        pool:
          max-active: 8
          max-idle: 8
          min-idle: 2
          max-wait: -1ms

# ═══════════════════════════════════════════════════════════════════════════
# SERVER CONFIGURATION
# ═══════════════════════════════════════════════════════════════════════════
server:
  port: ${SERVER_PORT:8083}
  servlet:
    context-path: /api/auth
  compression:
    enabled: true
    mime-types: application/json,application/xml,text/html,text/xml,text/plain
  error:
    include-message: always
    include-binding-errors: always
    include-stacktrace: on_param
    include-exception: false
  http2:
    enabled: true

# ═══════════════════════════════════════════════════════════════════════════
# EUREKA SERVICE DISCOVERY
# ═══════════════════════════════════════════════════════════════════════════
eureka:
  client:
    enabled: ${EUREKA_ENABLED:true}
    service-url:
      defaultZone: ${EUREKA_URL:http://localhost:8761/eureka/}
    register-with-eureka: true
    fetch-registry: true
    registry-fetch-interval-seconds: 30
    healthcheck:
      enabled: true

  instance:
    prefer-ip-address: ${EUREKA_PREFER_IP:false}
    hostname: ${INSTANCE_HOSTNAME:localhost}
    lease-renewal-interval-in-seconds: 30
    lease-expiration-duration-in-seconds: 90
    metadata-map:
      zone: ${INSTANCE_ZONE:zone1}
      version: '@project.version@'
      environment: ${SPRING_PROFILES_ACTIVE:dev}

# ═══════════════════════════════════════════════════════════════════════════
# JWT CONFIGURATION
# ═══════════════════════════════════════════════════════════════════════════
jwt:
  secret: ${JWT_SECRET:aVeryLongAndSecureSecretKeyForYouthConnectUgandaHackathonProjectWith256BitsMinimum}
  expiration: ${JWT_EXPIRATION:86400000}
  refresh-expiration: ${JWT_REFRESH_EXPIRATION:604800000}
  issuer: ${JWT_ISSUER:youth-connect-auth-service}
  audience: ${JWT_AUDIENCE:youth-connect-platform}

# ═══════════════════════════════════════════════════════════════════════════
# ACTUATOR CONFIGURATION
# ═══════════════════════════════════════════════════════════════════════════
management:
  endpoints:
    web:
      base-path: /actuator
      exposure:
        include: health,info,metrics,prometheus,flyway,loggers
  endpoint:
    health:
      show-details: ${HEALTH_SHOW_DETAILS:always}
      show-components: always
      probes:
        enabled: true
  health:
    db:
      enabled: true
    diskspace:
      enabled: true
      threshold: 10MB
    redis:
      enabled: true
  metrics:
    export:
      prometheus:
        enabled: true
    enable:
      jvm: true
      process: true
      system: true
      http: true
      logback: true
  info:
    env:
      enabled: true
    java:
      enabled: true
    os:
      enabled: true

# ═══════════════════════════════════════════════════════════════════════════
# LOGGING CONFIGURATION
# ═══════════════════════════════════════════════════════════════════════════
logging:
  level:
    root: ${LOG_LEVEL_ROOT:INFO}
    com.youthconnect.auth_service: ${LOG_LEVEL_APP:DEBUG}
    org.springframework: ${LOG_LEVEL_SPRING:INFO}
    org.springframework.web: ${LOG_LEVEL_WEB:DEBUG}
    org.springframework.security: ${LOG_LEVEL_SECURITY:DEBUG}
    org.hibernate: ${LOG_LEVEL_HIBERNATE:INFO}
    org.hibernate.SQL: ${LOG_LEVEL_SQL:DEBUG}
    org.hibernate.type.descriptor.sql.BasicBinder: ${LOG_LEVEL_SQL_PARAMS:TRACE}
    org.flywaydb: ${LOG_LEVEL_FLYWAY:INFO}
    com.zaxxer.hikari: ${LOG_LEVEL_HIKARI:INFO}
    com.netflix.discovery: ${LOG_LEVEL_EUREKA:INFO}
    feign: ${LOG_LEVEL_FEIGN:DEBUG}

  pattern:
    console: '%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %highlight(%-5level) %logger{36} - %msg%n'
    file: '%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n'

  file:
    name: ${LOG_FILE:logs/auth-service.log}
    max-size: 10MB
    max-history: 30

# ═══════════════════════════════════════════════════════════════════════════
# ✅ APPLICATION-SPECIFIC CONFIGURATION (CRITICAL FIX)
# ═══════════════════════════════════════════════════════════════════════════
app:
  # ✅ OAuth2 Configuration (Optional - Disabled by Default)
  oauth2:
    enabled: ${OAUTH2_ENABLED:false}
    redirect-uri: ${OAUTH2_REDIRECT_URI:http://localhost:3000/auth/callback}

  # ✅ CRITICAL FIX: CORS Security Configuration (REQUIRED for SecurityConfig)
  # This section was MISSING and causing the startup failure
  security:
    # Allowed origins for CORS requests (comma-separated list converted to array)
    allowed-origins:
      - http://localhost:3000      # React development server
      - http://localhost:3001      # Alternative React port
      - http://localhost:5173      # Vite development server
      - http://localhost:4200      # Angular development server

    # Allowed HTTP methods
    allowed-methods:
      - GET
      - POST
      - PUT
      - DELETE
      - PATCH
      - OPTIONS

    # Allowed request headers
    allowed-headers:
      - Authorization
      - Content-Type
      - X-Requested-With
      - Accept
      - Origin
      - Access-Control-Request-Method
      - Access-Control-Request-Headers

    # Headers exposed to browser
    exposed-headers:
      - Authorization
      - X-Total-Count
      - X-Page-Number
      - X-Page-Size

    # Allow credentials (cookies, auth)
    allow-credentials: true

    # Cache preflight response (seconds)
    max-age: 3600

    # Password policy
    password:
      min-length: 8
      require-uppercase: true
      require-lowercase: true
      require-digit: true
      require-special-char: true

    # Account lockout settings
    lockout:
      max-attempts: ${LOCKOUT_MAX_ATTEMPTS:5}
      duration-minutes: ${LOCKOUT_DURATION:30}

  # Password reset configuration
  password-reset:
    token-expiry-minutes: ${PASSWORD_RESET_EXPIRY:15}
    max-attempts: ${PASSWORD_RESET_MAX_ATTEMPTS:3}
    cleanup-cron: ${PASSWORD_RESET_CLEANUP_CRON:0 0 3 * * ?}

  # Email verification configuration
  email-verification:
    token-expiry-hours: ${EMAIL_VERIFY_EXPIRY:24}
    resend-limit: ${EMAIL_VERIFY_RESEND_LIMIT:5}

  # Token management
  token:
    blacklist-cleanup-cron: ${TOKEN_BLACKLIST_CLEANUP_CRON:0 0 2 * * ?}

  # USSD configuration
  ussd:
    enabled: ${USSD_ENABLED:true}
    session-timeout-minutes: ${USSD_SESSION_TIMEOUT:5}

# ═══════════════════════════════════════════════════════════════════════════
# PROFILE: Docker
# ═══════════════════════════════════════════════════════════════════════════
---
spring:
  config:
    activate:
      on-profile: docker

  # Docker database (container networking)
  datasource:
    url: jdbc:postgresql://postgres:5432/youthconnect_auth

  # Docker Redis
  data:
    redis:
      host: redis

# Docker Eureka
eureka:
  client:
    service-url:
      defaultZone: http://service-registry:8761/eureka/
  instance:
    prefer-ip-address: true