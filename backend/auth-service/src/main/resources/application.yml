# ═══════════════════════════════════════════════════════════════════════════
# AUTH SERVICE - PRODUCTION-READY CONFIGURATION
# ═══════════════════════════════════════════════════════════════════════════
# Version: 4.0.3 (Merged Fixed Eureka Client + Full OAuth2 Context)
# Date: 2025-11-29
# Description: Unified configuration for Database, Redis, OAuth2, JWT,
#              Service Discovery, and Docker profiles.
# ═══════════════════════════════════════════════════════════════════════════

# ───────────────────────────────────────────────────────────────────────────
# SPRING APPLICATION CONFIGURATION
# ───────────────────────────────────────────────────────────────────────────
spring:
  application:
    name: auth-service

  # ─────────────────────────────────────────────────────────────────────────
  # OAUTH2 CLIENT CONFIGURATION
  # ─────────────────────────────────────────────────────────────────────────
  security:
    oauth2:
      client:
        registration:
          # GOOGLE PROVIDER
          google:
            client-id: ${GOOGLE_CLIENT_ID:placeholder-id}
            client-secret: ${GOOGLE_CLIENT_SECRET:placeholder-secret}
            scope:
              - email
              - profile
            redirect-uri: "{baseUrl}/login/oauth2/code/{registrationId}"

          # FACEBOOK PROVIDER (Uncomment to enable)
          # facebook:
          #   client-id: ${FACEBOOK_CLIENT_ID:placeholder-id}
          #   client-secret: ${FACEBOOK_CLIENT_SECRET:placeholder-secret}
          #   scope: [email, public_profile]

  # ─────────────────────────────────────────────────────────────────────────
  # DATABASE CONFIGURATION (PostgreSQL)
  # ─────────────────────────────────────────────────────────────────────────
  datasource:
    url: jdbc:postgresql://${DB_HOST:localhost}:${DB_PORT:5432}/${DB_NAME:youthconnect_auth}
    username: ${DB_USER:youthconnect_user}
    password: ${DB_PASSWORD:YouthConnect2024!}
    driver-class-name: org.postgresql.Driver

    # HikariCP Performance Tuning
    hikari:
      maximum-pool-size: ${DB_POOL_SIZE:10}
      minimum-idle: 2
      connection-timeout: 30000 # 30s
      max-lifetime: 1800000     # 30m
      idle-timeout: 600000      # 10m
      pool-name: AuthServiceHikariPool

  # ─────────────────────────────────────────────────────────────────────────
  # JPA / HIBERNATE CONFIGURATION
  # ─────────────────────────────────────────────────────────────────────────
  jpa:
    # Production safety: 'validate' checks schema matches entities but doesn't alter DB
    hibernate:
      ddl-auto: validate
      naming:
        physical-strategy: org.hibernate.boot.model.naming.PhysicalNamingStrategyStandardImpl
        implicit-strategy: org.hibernate.boot.model.naming.ImplicitNamingStrategyJpaCompliantImpl
    database-platform: org.hibernate.dialect.PostgreSQLDialect
    show-sql: ${SHOW_SQL:false}
    properties:
      hibernate:
        format_sql: true
        globally_quoted_identifiers: false
        jdbc:
          batch_size: 20
        id:
          new_generator_mappings: true

  # ─────────────────────────────────────────────────────────────────────────
  # FLYWAY MIGRATION
  # ─────────────────────────────────────────────────────────────────────────
  flyway:
    enabled: true
    baseline-on-migrate: true
    baseline-version: 0
    locations: classpath:db/migration
    validate-on-migrate: true
    clean-disabled: false # Set to true in strict production to prevent data wipe
    table: flyway_schema_history

  # ─────────────────────────────────────────────────────────────────────────
  # REDIS CONFIGURATION (Caching & Sessions)
  # ─────────────────────────────────────────────────────────────────────────
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      database: ${REDIS_DB:0}
      timeout: 3000ms

# ═══════════════════════════════════════════════════════════════════════════
# SERVER CONFIGURATION
# ═══════════════════════════════════════════════════════════════════════════
server:
  port: ${SERVER_PORT:8083}
  # ✅ CONTEXT PATH REMOVED
  # All controllers should define explicit paths (e.g., @RequestMapping("/api/auth"))
  # servlet:
  #   context-path: /api/auth

# ═══════════════════════════════════════════════════════════════════════════
# EUREKA SERVICE DISCOVERY (Fixed for Jersey/Transport Issues)
# ═══════════════════════════════════════════════════════════════════════════
eureka:
  client:
    enabled: ${EUREKA_ENABLED:true}
    # ✅ CRITICAL FIX: Forces use of RestTemplate over Jersey
    # This prevents the "UnknownContentTypeException" and ClassNotFound crashes
    release-jersey-client: true

    service-url:
      defaultZone: http://${EUREKA_USERNAME:admin}:${EUREKA_PASSWORD:changeme}@${EUREKA_HOST:localhost}:${EUREKA_PORT:8761}/eureka/

    register-with-eureka: true
    fetch-registry: true
    registry-fetch-interval-seconds: 30

  instance:
    # Prefer IP ensures docker containers talk via IP, not unresolvable hostnames
    prefer-ip-address: ${EUREKA_PREFER_IP:false}
    hostname: ${INSTANCE_HOSTNAME:localhost}
    lease-renewal-interval-in-seconds: 30
    lease-expiration-duration-in-seconds: 90

# ═══════════════════════════════════════════════════════════════════════════
# JWT CONFIGURATION
# ═══════════════════════════════════════════════════════════════════════════
jwt:
  secret: ${JWT_SECRET:aVeryLongAndSecureSecretKeyForYouthConnectUgandaHackathonProjectWith256BitsMinimum}
  expiration: ${JWT_EXPIRATION:86400000}          # 24 Hours
  refresh-expiration: ${JWT_REFRESH_EXPIRATION:604800000} # 7 Days
  issuer: ${JWT_ISSUER:youth-connect-auth-service}
  audience: ${JWT_AUDIENCE:youth-connect-platform}

# ═══════════════════════════════════════════════════════════════════════════
# LOGGING CONFIGURATION
# ═══════════════════════════════════════════════════════════════════════════
logging:
  level:
    root: ${LOG_LEVEL_ROOT:INFO}
    com.youthconnect.auth_service: ${LOG_LEVEL_APP:DEBUG}
    org.springframework.web: DEBUG
    org.springframework.security: INFO
    org.hibernate.SQL: ${LOG_LEVEL_SQL:INFO}

# ═══════════════════════════════════════════════════════════════════════════
# APP SPECIFIC (CORS)
# ═══════════════════════════════════════════════════════════════════════════
app:
  security:
    allowed-origins: "http://localhost:3000,http://localhost:3001,http://localhost:5173"
    allowed-methods: "GET,POST,PUT,DELETE,PATCH,OPTIONS"
    allowed-headers: "Authorization,Content-Type,X-Requested-With"
    allow-credentials: true

# ═══════════════════════════════════════════════════════════════════════════
# ACTUATOR (Health & Metrics)
# ═══════════════════════════════════════════════════════════════════════════
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus
      base-path: /actuator
  endpoint:
    health:
      show-details: when-authorized
  health:
    db: {enabled: true}
    redis: {enabled: true}

# ═══════════════════════════════════════════════════════════════════════════
# DOCKER PROFILE (Activated via spring_profiles_active=docker)
# ═══════════════════════════════════════════════════════════════════════════
---
spring:
  config:
    activate:
      on-profile: docker

  datasource:
    # Uses container name 'postgres'
    url: jdbc:postgresql://postgres:5432/youthconnect_auth

  data:
    redis:
      # Uses container name 'redis'
      host: redis

  eureka:
    client:
      service-url:
        # Uses container name 'service-registry'
        defaultZone: http://service-registry:8761/eureka/
    instance:
      prefer-ip-address: true