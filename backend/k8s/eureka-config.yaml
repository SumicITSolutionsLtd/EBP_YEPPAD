# =============================================================================
# ENTREPRENEURSHIP BOOSTER PLATFORM (EPB)
# Kubernetes Configuration - Complete Deployment
# =============================================================================
# File: backend/k8s/eureka-config.yaml
# Version: 1.0
# Last Updated: 2025-11-08
#
# DESCRIPTION:
#   Complete Kubernetes configuration including:
#   - Namespace for resource organization
#   - ConfigMaps for non-sensitive configuration
#   - Secrets for sensitive credentials
#   - Service Registry (Eureka) deployment
#   - API Gateway deployment
#   - All microservice deployments
#   - Services (ClusterIP for internal, LoadBalancer for external)
#   - Ingress with TLS for HTTPS
#   - Horizontal Pod Autoscaler for automatic scaling
#
# USAGE:
#   Apply all resources:
#     kubectl apply -f backend/k8s/eureka-config.yaml
#
#   Check deployment status:
#     kubectl get all -n epb
#     kubectl get pods -n epb -w
#
#   View logs:
#     kubectl logs -f deployment/api-gateway -n epb
#     kubectl logs -f deployment/auth-service -n epb
#
#   Scale deployments:
#     kubectl scale deployment api-gateway --replicas=5 -n epb
#
#   Delete all resources:
#     kubectl delete namespace epb
#
# PREREQUISITES:
#   - Kubernetes cluster (1.24+)
#   - kubectl CLI configured
#   - cert-manager (for TLS certificates)
#   - NGINX Ingress Controller
# =============================================================================

---
# =============================================================================
# NAMESPACE
# =============================================================================
# Namespaces provide a scope for names and allow resource isolation
# All EPB resources are deployed in the 'epb' namespace
apiVersion: v1
kind: Namespace
metadata:
  name: epb
  labels:
    name: epb
    environment: production
    team: engineering

---
# =============================================================================
# SECRET: Eureka Credentials
# =============================================================================
# Stores credentials for Eureka service registry authentication
# All microservices use these credentials to register with Eureka
#
# ENCODING:
#   Values must be base64 encoded
#   To encode: echo -n "your-value" | base64
#   To decode: echo "base64-value" | base64 -d
#
# SECURITY:
#   ⚠️ In production, manage secrets using:
#   - Kubernetes External Secrets Operator
#   - AWS Secrets Manager
#   - HashiCorp Vault
#   - Azure Key Vault
apiVersion: v1
kind: Secret
metadata:
  name: eureka-credentials
  namespace: epb
  labels:
    app: service-registry
    managed-by: ops-team
type: Opaque
data:
  # username: admin (base64: YWRtaW4=)
  EUREKA_USERNAME: YWRtaW4=

  # password: changeme (base64: Y2hhbmdlbWU=)
  # ⚠️ CRITICAL: Change this before production deployment!
  # Generate: echo -n "your-strong-password" | base64
  EUREKA_PASSWORD: Y2hhbmdlbWU=

---
# =============================================================================
# SECRET: Database Credentials
# =============================================================================
# Stores PostgreSQL connection credentials
# Used by all microservices to connect to their dedicated databases
apiVersion: v1
kind: Secret
metadata:
  name: postgres-credentials
  namespace: epb
  labels:
    app: postgres
type: Opaque
data:
  # Database admin user (base64 encoded)
  POSTGRES_USER: ZXBiX2FkbWlu

  # Database admin password (base64 encoded)
  # ⚠️ Generate strong password: openssl rand -base64 32 | base64
  POSTGRES_PASSWORD: UmVwbGFjZVdpdGhTdHJvbmdEQlJvb3RQYXNzd29yZDIwMjUh

  # Application user (base64 encoded)
  DB_USER: ZXBiX2FwcF91c2Vy

  # Application password (base64 encoded)
  DB_PASSWORD: UmVwbGFjZVdpdGhTdHJvbmdBcHBVc2VyUGFzc3dvcmQyMDI1IQ==

---
# =============================================================================
# SECRET: Redis Credentials
# =============================================================================
# Stores Redis authentication password
# Used for caching, session management, and rate limiting
apiVersion: v1
kind: Secret
metadata:
  name: redis-credentials
  namespace: epb
  labels:
    app: redis
type: Opaque
data:
  # Redis password (base64 encoded)
  # ⚠️ Generate strong password: openssl rand -base64 32 | base64
  REDIS_PASSWORD: UmVwbGFjZVdpdGhTdHJvbmdSZWRpc1Bhc3N3b3JkMjAyNSE=

---
# =============================================================================
# SECRET: JWT Configuration
# =============================================================================
# Stores JWT signing key (must be identical across all services)
# Used for token generation and validation
apiVersion: v1
kind: Secret
metadata:
  name: jwt-secret
  namespace: epb
  labels:
    app: auth
type: Opaque
data:
  # JWT secret key (base64 encoded)
  # ⚠️ CRITICAL: Must be strong (minimum 256 bits)
  # Generate: openssl rand -base64 64 | base64
  JWT_SECRET: UmVwbGFjZVdpdGhBVmVyeUxvbmdBbmRTZWN1cmVSYW5kb21LZXlCYXNlNjRFbmNvZGVkTWluaW11bTI1NkJpdHNGb3JQcm9kdWN0aW9uVXNlMjAyNQ==

---
# =============================================================================
# CONFIGMAP: Eureka Configuration
# =============================================================================
# Non-sensitive configuration for Eureka service registry
# Shared across all microservices
apiVersion: v1
kind: ConfigMap
metadata:
  name: eureka-config
  namespace: epb
  labels:
    app: service-registry
data:
  # Eureka server hostname (Kubernetes service name)
  EUREKA_HOST: service-registry.epb.svc.cluster.local

  # Eureka server port
  EUREKA_PORT: "8761"

  # Spring profile (activates production configuration)
  SPRING_PROFILES_ACTIVE: kubernetes

  # Logging configuration
  LOGGING_LEVEL_ROOT: INFO
  LOGGING_LEVEL_COM_EPB: DEBUG

  # Timezone for all services
  TZ: Africa/Kampala

---
# =============================================================================
# CONFIGMAP: Database Configuration
# =============================================================================
# PostgreSQL connection details and database names
# Used by all microservices to construct connection URLs
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-config
  namespace: epb
  labels:
    app: postgres
data:
  # PostgreSQL server hostname (Kubernetes service name)
  POSTGRES_HOST: postgres.epb.svc.cluster.local

  # PostgreSQL port
  POSTGRES_PORT: "5432"

  # Dedicated database per microservice
  POSTGRES_DB_AUTH: epb_auth
  POSTGRES_DB_USER: epb_user
  POSTGRES_DB_OPPORTUNITY: epb_opportunity
  POSTGRES_DB_CONTENT: epb_content
  POSTGRES_DB_MENTOR: epb_mentor
  POSTGRES_DB_NOTIFICATION: epb_notification
  POSTGRES_DB_FILE: epb_file
  POSTGRES_DB_AI: epb_ai
  POSTGRES_DB_ANALYTICS: epb_analytics
  POSTGRES_DB_USSD: epb_ussd
  POSTGRES_DB_JOB: epb_job
  POSTGRES_DB_EDGE: epb_edge

---
# =============================================================================
# CONFIGMAP: Application Configuration
# =============================================================================
# General application settings shared across services
apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
  namespace: epb
  labels:
    app: epb
data:
  # JWT token expiration (seconds)
  JWT_ACCESS_TOKEN_EXPIRY: "900"        # 15 minutes
  JWT_REFRESH_TOKEN_EXPIRY: "604800"    # 7 days
  JWT_ISSUER: epb-platform
  JWT_AUDIENCE: epb-users

  # CORS configuration
  CORS_ALLOWED_ORIGINS: "http://localhost:3000,https://entrepreneurshipbooster.ug"
  CORS_ALLOWED_METHODS: "GET,POST,PUT,DELETE,PATCH,OPTIONS"

  # Rate limiting
  RATE_LIMIT_ENABLED: "true"
  RATE_LIMIT_REQUESTS: "100"
  RATE_LIMIT_DURATION: "60"

---
# =============================================================================
# DEPLOYMENT: Service Registry (Eureka)
# =============================================================================
# Eureka service discovery server
# All microservices register here to find each other
#
# HIGH AVAILABILITY:
#   - 3 replicas for fault tolerance
#   - PodDisruptionBudget to maintain quorum
#   - AntiAffinity to spread across nodes
apiVersion: apps/v1
kind: Deployment
metadata:
  name: service-registry
  namespace: epb
  labels:
    app: service-registry
    component: infrastructure
    version: v1
spec:
  # Run 3 instances for high availability
  replicas: 3

  # Label selector for pods managed by this deployment
  selector:
    matchLabels:
      app: service-registry

  # Pod template
  template:
    metadata:
      labels:
        app: service-registry
        component: infrastructure
        version: v1
    spec:
      # Anti-affinity: Spread pods across different nodes
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                        - service-registry
                topologyKey: kubernetes.io/hostname

      # Containers
      containers:
        - name: service-registry
          image: epb/service-registry:latest
          imagePullPolicy: Always

          # Container ports
          ports:
            - containerPort: 8761
              name: http
              protocol: TCP

          # Environment variables
          env:
            # Eureka credentials from Secret
            - name: SPRING_SECURITY_USER_NAME
              valueFrom:
                secretKeyRef:
                  name: eureka-credentials
                  key: EUREKA_USERNAME

            - name: SPRING_SECURITY_USER_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: eureka-credentials
                  key: EUREKA_PASSWORD

            # Spring profile from ConfigMap
            - name: SPRING_PROFILES_ACTIVE
              valueFrom:
                configMapKeyRef:
                  name: eureka-config
                  key: SPRING_PROFILES_ACTIVE

            # Timezone from ConfigMap
            - name: TZ
              valueFrom:
                configMapKeyRef:
                  name: eureka-config
                  key: TZ

            # Direct environment variables
            - name: SERVER_PORT
              value: "8761"

            - name: EUREKA_INSTANCE_HOSTNAME
              value: service-registry

            # JVM memory configuration
            - name: JAVA_OPTS
              value: "-Xms256m -Xmx512m -XX:+UseG1GC"

          # Resource requests and limits
          # Requests: Guaranteed resources
          # Limits: Maximum resources
          resources:
            requests:
              memory: "512Mi"
              cpu: "500m"
            limits:
              memory: "1Gi"
              cpu: "1000m"

          # Liveness probe: Restart if unhealthy
          # Kubernetes restarts container if probe fails
          livenessProbe:
            httpGet:
              path: /actuator/health/liveness
              port: 8761
            initialDelaySeconds: 90    # Wait before first probe
            periodSeconds: 10          # Check every 10 seconds
            timeoutSeconds: 5          # Timeout after 5 seconds
            failureThreshold: 3        # Restart after 3 failures

          # Readiness probe: Remove from service if not ready
          # Kubernetes stops sending traffic if probe fails
          readinessProbe:
            httpGet:
              path: /actuator/health/readiness
              port: 8761
            initialDelaySeconds: 60
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3

---
# =============================================================================
# SERVICE: Service Registry (ClusterIP)
# =============================================================================
# Internal service for Eureka
# Provides stable DNS name: service-registry.epb.svc.cluster.local
apiVersion: v1
kind: Service
metadata:
  name: service-registry
  namespace: epb
  labels:
    app: service-registry
spec:
  # ClusterIP: Internal-only (not exposed outside cluster)
  type: ClusterIP

  # Route traffic to pods with matching labels
  selector:
    app: service-registry

  # Service ports
  ports:
    - port: 8761              # Service port
      targetPort: 8761        # Container port
      protocol: TCP
      name: http

---
# =============================================================================
# DEPLOYMENT: API Gateway
# =============================================================================
# Single entry point for all external API requests
# Handles routing, authentication, rate limiting, and CORS
apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-gateway
  namespace: epb
  labels:
    app: api-gateway
    component: gateway
spec:
  # Start with 2 replicas, auto-scale based on load
  replicas: 2

  selector:
    matchLabels:
      app: api-gateway

  template:
    metadata:
      labels:
        app: api-gateway
        component: gateway
    spec:
      containers:
        - name: api-gateway
          image: epb/api-gateway:latest
          imagePullPolicy: Always

          ports:
            - containerPort: 8080
              name: http
              protocol: TCP

          env:
            # Eureka credentials
            - name: EUREKA_USERNAME
              valueFrom:
                secretKeyRef:
                  name: eureka-credentials
                  key: EUREKA_USERNAME

            - name: EUREKA_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: eureka-credentials
                  key: EUREKA_PASSWORD

            # JWT secret
            - name: JWT_SECRET
              valueFrom:
                secretKeyRef:
                  name: jwt-secret
                  key: JWT_SECRET

            # Redis password
            - name: SPRING_REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: redis-credentials
                  key: REDIS_PASSWORD

            # Eureka configuration from ConfigMap
            - name: EUREKA_HOST
              valueFrom:
                configMapKeyRef:
                  name: eureka-config
                  key: EUREKA_HOST

            - name: EUREKA_PORT
              valueFrom:
                configMapKeyRef:
                  name: eureka-config
                  key: EUREKA_PORT

            # Build Eureka URL dynamically
            - name: EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE
              value: "http://$(EUREKA_USERNAME):$(EUREKA_PASSWORD)@$(EUREKA_HOST):$(EUREKA_PORT)/eureka/"

            # Application configuration
            - name: SERVER_PORT
              value: "8080"

            - name: SPRING_APPLICATION_NAME
              value: api-gateway

            - name: SPRING_PROFILES_ACTIVE
              valueFrom:
                configMapKeyRef:
                  name: eureka-config
                  key: SPRING_PROFILES_ACTIVE

            # Redis configuration
            - name: SPRING_REDIS_HOST
              value: redis.epb.svc.cluster.local

            - name: SPRING_REDIS_PORT
              value: "6379"

            # CORS from ConfigMap
            - name: CORS_ALLOWED_ORIGINS
              valueFrom:
                configMapKeyRef:
                  name: app-config
                  key: CORS_ALLOWED_ORIGINS

            # Rate limiting
            - name: RATE_LIMIT_ENABLED
              valueFrom:
                configMapKeyRef:
                  name: app-config
                  key: RATE_LIMIT_ENABLED

            # JVM options
            - name: JAVA_OPTS
              value: "-Xms512m -Xmx1g -XX:+UseG1GC"

          # Resource allocation
          resources:
            requests:
              memory: "512Mi"
              cpu: "500m"
            limits:
              memory: "1Gi"
              cpu: "1000m"

          # Health checks
          livenessProbe:
            httpGet:
              path: /actuator/health/liveness
              port: 8080
            initialDelaySeconds: 90
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3

          readinessProbe:
            httpGet:
              path: /actuator/health/readiness
              port: 8080
            initialDelaySeconds: 60
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3

---
# =============================================================================
# SERVICE: API Gateway (LoadBalancer)
# =============================================================================
# Exposes API Gateway to external traffic
# Cloud providers automatically provision load balancer
apiVersion: v1
kind: Service
metadata:
  name: api-gateway
  namespace: epb
  labels:
    app: api-gateway
spec:
  # LoadBalancer: Exposes service externally
  # Cloud provider provisions external IP/DNS
  type: LoadBalancer

  selector:
    app: api-gateway

  ports:
    - port: 80                # External port
      targetPort: 8080        # Container port
      protocol: TCP
      name: http

---
# =============================================================================
# DEPLOYMENT: Auth Service
# =============================================================================
# Handles user authentication and JWT token management
apiVersion: apps/v1
kind: Deployment
metadata:
  name: auth-service
  namespace: epb
  labels:
    app: auth-service
spec:
  replicas: 2

  selector:
    matchLabels:
      app: auth-service

  template:
    metadata:
      labels:
        app: auth-service
    spec:
      containers:
        - name: auth-service
          image: epb/auth-service:latest
          imagePullPolicy: Always

          ports:
            - containerPort: 8082
              name: http

          env:
            # Eureka configuration
            - name: EUREKA_USERNAME
              valueFrom:
                secretKeyRef:
                  name: eureka-credentials
                  key: EUREKA_USERNAME

            - name: EUREKA_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: eureka-credentials
                  key: EUREKA_PASSWORD

            - name: EUREKA_CLIENT_SERVICE_URL_DEFAULTZONE
              value: "http://$(EUREKA_USERNAME):$(EUREKA_PASSWORD)@service-registry.epb.svc.cluster.local:8761/eureka/"

            # Database configuration
            - name: SPRING_DATASOURCE_URL
              value: "jdbc:postgresql://postgres.epb.svc.cluster.local:5432/epb_auth"

            - name: SPRING_DATASOURCE_USERNAME
              valueFrom:
                secretKeyRef:
                  name: postgres-credentials
                  key: DB_USER

            - name: SPRING_DATASOURCE_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-credentials
                  key: DB_PASSWORD

            # JWT configuration
            - name: JWT_SECRET
              valueFrom:
                secretKeyRef:
                  name: jwt-secret
                  key: JWT_SECRET

            # Redis configuration
            - name: SPRING_REDIS_HOST
              value: redis.epb.svc.cluster.local

            - name: SPRING_REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: redis-credentials
                  key: REDIS_PASSWORD

            # Application configuration
            - name: SERVER_PORT
              value: "8082"

            - name: SPRING_APPLICATION_NAME
              value: auth-service

            - name: SPRING_PROFILES_ACTIVE
              value: kubernetes

          resources:
            requests:
              memory: "512Mi"
              cpu: "500m"
            limits:
              memory: "1Gi"
              cpu: "1000m"

          livenessProbe:
            httpGet:
              path: /actuator/health/liveness
              port: 8082
            initialDelaySeconds: 90
            periodSeconds: 10

          readinessProbe:
            httpGet:
              path: /actuator/health/readiness
              port: 8082
            initialDelaySeconds: 60
            periodSeconds: 10

---
# =============================================================================
# SERVICE: Auth Service (ClusterIP)
# =============================================================================
apiVersion: v1
kind: Service
metadata:
  name: auth-service
  namespace: epb
spec:
  type: ClusterIP
  selector:
    app: auth-service
  ports:
    - port: 8082
      targetPort: 8082

---
# =============================================================================
# INGRESS: HTTPS Traffic Routing
# =============================================================================
# Routes external HTTPS traffic to API Gateway
# Automatically provisions TLS certificates via cert-manager
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: epb-ingress
  namespace: epb
  annotations:
    # Use NGINX Ingress Controller
    kubernetes.io/ingress.class: nginx

    # Automatic TLS certificate provisioning
    cert-manager.io/cluster-issuer: letsencrypt-prod

    # Force HTTPS redirect
    nginx.ingress.kubernetes.io/ssl-redirect: "true"

    # Max upload size (for file uploads)
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"
spec:
  # TLS configuration
  tls:
    - hosts:
        - api.entrepreneurshipbooster.com
      secretName: epb-tls    # cert-manager creates this secret

  # Routing rules
  rules:
    - host: api.entrepreneurshipbooster.com
      http:
        paths:
          # Route all paths to API Gateway
          - path: /
            pathType: Prefix
            backend:
              service:
                name: api-gateway
                port:
                  number: 80

---
# =============================================================================
# HORIZONTAL POD AUTOSCALER: API Gateway
# =============================================================================
# Automatically scales API Gateway based on CPU/memory usage
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: api-gateway-hpa
  namespace: epb
spec:
  # Target deployment to scale
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: api-gateway

  # Minimum and maximum replicas
  minReplicas: 2
  maxReplicas: 10

  # Scaling metrics
  metrics:
    # Scale based on CPU usage
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70    # Scale up if CPU > 70%

    # Scale based on memory usage
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80    # Scale up if memory > 80%

---
# =============================================================================
# KUBECTL COMMANDS REFERENCE
# =============================================================================
#
# DEPLOYMENT:
#   kubectl apply -f backend/k8s/eureka-config.yaml
#
# VERIFICATION:
#   kubectl get all -n epb
#   kubectl get pods -n epb
#   kubectl get services -n epb
#   kubectl get ingress -n epb
#
# LOGS:
#   kubectl logs -f deployment/api-gateway -n epb
#   kubectl logs -f deployment/auth-service -n epb
#
# EXEC INTO POD:
#   kubectl exec -it deployment/api-gateway -n epb -- /bin/sh
#
# PORT FORWARDING (for testing):
#   kubectl port-forward svc/api-gateway 8080:80 -n epb
#   kubectl port-forward svc/service-registry 8761:8761 -n epb
#
# VIEW SECRETS (decoded):
#   kubectl get secret eureka-credentials -n epb -o jsonpath='{.data.EUREKA_USERNAME}' | base64 -d
#
# UPDATE SECRETS:
#   kubectl create secret generic jwt-secret \
#     --from-literal=JWT_SECRET='your-new-secret' \
#     --namespace=epb \
#     --dry-run=client -o yaml | kubectl apply -f -
#
# RESTART DEPLOYMENTS:
#   kubectl rollout restart deployment/api-gateway -n epb
#
# SCALE MANUALLY:
#   kubectl scale deployment api-gateway --replicas=5 -n epb
#
# DELETE NAMESPACE (removes all resources):
#   kubectl delete namespace epb
#
# =============================================================================