# ═══════════════════════════════════════════════════════════════════════════
# API GATEWAY - Production Configuration
# application-prod.yml
# ═══════════════════════════════════════════════════════════════════════════
# IMPORTANT: This file contains production-specific overrides
# Base configuration is in application.yml
# ═══════════════════════════════════════════════════════════════════════════

# =============================================================================
# SERVER CONFIGURATION (Production)
# =============================================================================
server:
  port: ${SERVER_PORT:8088}
  shutdown: graceful  # Allows in-flight requests to complete before shutdown

  # Production SSL/TLS Configuration
  # Uncomment when using HTTPS in production
  # ssl:
  #   enabled: true
  #   key-store: ${SSL_KEY_STORE:/app/keystore.p12}
  #   key-store-password: ${SSL_KEY_STORE_PASSWORD}
  #   key-store-type: PKCS12
  #   key-alias: youthconnect

# =============================================================================
# SPRING CONFIGURATION (Production)
# =============================================================================
spring:
  application:
    name: api-gateway

  # Multipart file upload (Production limits)
  servlet:
    multipart:
      enabled: true
      max-file-size: 50MB
      max-request-size: 100MB
      file-size-threshold: 2MB

  # Graceful shutdown configuration
  lifecycle:
    timeout-per-shutdown-phase: 30s  # Wait 30s for graceful shutdown

  cloud:
    gateway:
      # Enable discovery locator for production
      discovery:
        locator:
          enabled: true
          lower-case-service-id: true

      # Production CORS settings
      globalcors:
        cors-configurations:
          '[/**]':
            allowedOrigins:
              - ${CORS_ALLOWED_ORIGINS:https://youthconnect.ug,https://www.youthconnect.ug}
            allowedMethods: [GET, POST, PUT, DELETE, PATCH, OPTIONS]
            allowedHeaders: "*"
            exposedHeaders:
              - "Authorization"
              - "X-Total-Count"
              - "X-User-Id"
              - "Content-Disposition"
              - "X-File-Name"
              - "X-File-Size"
            allowCredentials: true
            maxAge: 3600

      # Production HTTP client settings
      httpclient:
        connect-timeout: 10000
        response-timeout: 120s
        pool:
          type: elastic
          max-idle-time: 60s
          max-life-time: 120s
          max-connections: 500
          # Production-specific pool settings
          eviction-interval: 30s
          acquire-timeout: 45000

# =============================================================================
# EUREKA CLIENT (Production)
# =============================================================================
eureka:
  client:
    service-url:
      defaultZone: ${EUREKA_SERVER_URL:http://${EUREKA_USERNAME:admin}:${EUREKA_PASSWORD:changeme}@${EUREKA_HOST:service-registry}:${EUREKA_PORT:8761}/eureka/}
    register-with-eureka: true
    fetch-registry: true
    registry-fetch-interval-seconds: 10  # Less frequent in production

    # Production-specific settings
    eureka-server-connect-timeout-seconds: 10
    eureka-server-read-timeout-seconds: 10

  instance:
    prefer-ip-address: true
    instance-id: ${spring.application.name}:${server.port}
    lease-renewal-interval-in-seconds: 10  # Heartbeat every 10 seconds
    lease-expiration-duration-in-seconds: 30  # Mark as down after 30 seconds
    hostname: ${HOSTNAME:api-gateway}

    # Production metadata
    metadata-map:
      environment: production
      version: ${BUILD_VERSION:1.0.0}
      zone: ${AVAILABILITY_ZONE:default}

# =============================================================================
# RESILIENCE4J (Production - Stricter limits)
# =============================================================================
resilience4j:
  circuitbreaker:
    configs:
      default:
        register-health-indicator: true
        sliding-window-size: 20  # Larger window for production
        sliding-window-type: COUNT_BASED
        minimum-number-of-calls: 10  # More calls before opening
        failure-rate-threshold: 50
        wait-duration-in-open-state: 30s  # Longer wait in production
        permitted-number-of-calls-in-half-open-state: 5
        slow-call-duration-threshold: 10s
        slow-call-rate-threshold: 50
        automatic-transition-from-open-to-half-open-enabled: true

    instances:
      authServiceCircuitBreaker:
        base-config: default
        failure-rate-threshold: 40
        wait-duration-in-open-state: 20s

      userServiceCircuitBreaker:
        base-config: default
        sliding-window-size: 20
        minimum-number-of-calls: 10

      fileServiceCircuitBreaker:
        base-config: default
        sliding-window-size: 25
        minimum-number-of-calls: 12
        failure-rate-threshold: 55
        wait-duration-in-open-state: 25s
        slow-call-duration-threshold: 15s

  # Production time limiters
  timelimiter:
    instances:
      authServiceCircuitBreaker:
        timeout-duration: 8s
        cancel-running-future: true

      fileServiceCircuitBreaker:
        timeout-duration: 150s  # Longer for file operations
        cancel-running-future: true

  # Production retry configuration
  retry:
    instances:
      authServiceCircuitBreaker:
        max-attempts: 2  # Fewer retries in production
        wait-duration: 1s
        enable-exponential-backoff: true
        exponential-backoff-multiplier: 2

      fileServiceCircuitBreaker:
        max-attempts: 1  # No retries for file uploads
        wait-duration: 3s

# =============================================================================
# JWT CONFIGURATION (Production - Strict)
# =============================================================================
jwt:
  secret: ${JWT_SECRET}  # MUST be set via environment variable
  expiration: ${JWT_EXPIRATION:86400000}  # 24 hours
  issuer: ${JWT_ISSUER:youth-connect-uganda}

# =============================================================================
# RATE LIMITING (Production - Stricter)
# =============================================================================
app:
  security:
    rate-limit:
      enabled: true
      requests-per-minute: 100
      burst-capacity: 120  # Lower burst in production
      auth-requests-per-minute: 15  # Stricter auth limits
      ussd-requests-per-minute: 50
      file-upload-requests-per-minute: 15
      file-download-requests-per-minute: 80

# =============================================================================
# LOGGING (Production - Less verbose)
# =============================================================================
logging:
  level:
    root: INFO
    com.youthconnect: INFO  # No DEBUG in production
    org.springframework.cloud.gateway: WARN
    io.github.resilience4j: INFO
    org.springframework.web.multipart: WARN
    com.netflix.discovery: WARN  # Less Eureka noise

  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"

  file:
    name: ${LOGGING_FILE_NAME:/var/log/youthconnect/api-gateway.log}
    max-size: ${LOGGING_FILE_MAX_SIZE:50MB}  # Larger files in production
    max-history: ${LOGGING_FILE_MAX_HISTORY:60}  # Keep 60 days
    total-size-cap: 2GB  # Maximum log storage

# =============================================================================
# ACTUATOR (Production - Restricted)
# =============================================================================
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus  # Remove 'gateway' in production
      base-path: /actuator

  endpoint:
    health:
      show-details: when-authorized  # Hide details from public
      show-components: when-authorized

  metrics:
    export:
      prometheus:
        enabled: true
    distribution:
      percentiles-histogram:
        http.server.requests: true
    tags:
      application: ${spring.application.name}
      environment: production

  health:
    circuitbreakers:
      enabled: true

# =============================================================================
# PRODUCTION NOTES
# =============================================================================
#
# 1. SECURITY:
#    - Always use HTTPS in production (uncomment SSL config)
#    - Set strong JWT_SECRET (min 256 bits)
#    - Use secrets management (AWS Secrets Manager, HashiCorp Vault)
#    - Enable Spring Security for actuator endpoints
#
# 2. PERFORMANCE:
#    - Monitor circuit breaker states
#    - Watch for rate limiting issues
#    - Track slow requests (> 5s)
#    - Monitor heap usage
#
# 3. LOGGING:
#    - Centralized logging (ELK, CloudWatch)
#    - Log aggregation and analysis
#    - Alert on ERROR logs
#
# 4. SCALING:
#    - Run multiple gateway instances behind load balancer
#    - Use Redis for distributed rate limiting
#    - Enable sticky sessions if needed
#
# 5. MONITORING:
#    - Prometheus + Grafana for metrics
#    - Set up alerts for circuit breakers
#    - Monitor response times
#    - Track error rates
#
# =============================================================================