# ═══════════════════════════════════════════════════════════════════════════
# API GATEWAY - OAuth2 Routes Configuration
# File: backend/api-gateway/src/main/resources/application.yml
# ═══════════════════════════════════════════════════════════════════════════

spring:
  cloud:
    gateway:
      routes:
        # ═══════════════════════════════════════════════════════════════════
        # ✅ NEW: OAuth2 Authentication Routes
        # ═══════════════════════════════════════════════════════════════════

        # Google Sign-In
        - id: auth-service-oauth2-google
          uri: lb://AUTH-SERVICE
          predicates:
            - Path=/api/auth/oauth2/google
            - Method=POST
          filters:
            - name: CircuitBreaker
              args:
                name: authServiceCircuitBreaker
                fallbackUri: forward:/fallback/auth
          metadata:
            description: "Google OAuth2 login endpoint"
            public: true
            response-timeout: 10000

        # Facebook Login (Future)
        - id: auth-service-oauth2-facebook
          uri: lb://AUTH-SERVICE
          predicates:
            - Path=/api/auth/oauth2/facebook
            - Method=POST
          filters:
            - name: CircuitBreaker
              args:
                name: authServiceCircuitBreaker
                fallbackUri: forward:/fallback/auth
          metadata:
            description: "Facebook OAuth2 login endpoint"
            public: true
            response-timeout: 10000

        # Apple Sign-In (Future)
        - id: auth-service-oauth2-apple
          uri: lb://AUTH-SERVICE
          predicates:
            - Path=/api/auth/oauth2/apple
            - Method=POST
          filters:
            - name: CircuitBreaker
              args:
                name: authServiceCircuitBreaker
                fallbackUri: forward:/fallback/auth
          metadata:
            description: "Apple Sign-In endpoint"
            public: true
            response-timeout: 10000

        # OAuth2 Success Callback (from Spring Security)
        - id: auth-service-oauth2-callback
          uri: lb://AUTH-SERVICE
          predicates:
            - Path=/login/oauth2/code/**
            - Method=GET
          filters:
            - name: CircuitBreaker
              args:
                name: authServiceCircuitBreaker
          metadata:
            description: "OAuth2 provider callback endpoint"
            public: true

        # OAuth2 Authorization Redirect
        - id: auth-service-oauth2-authorize
          uri: lb://AUTH-SERVICE
          predicates:
            - Path=/oauth2/authorization/**
            - Method=GET
          filters:
            - name: CircuitBreaker
              args:
                name: authServiceCircuitBreaker
          metadata:
            description: "OAuth2 authorization redirect"
            public: true

        # ═══════════════════════════════════════════════════════════════════
        # Existing Auth Service Routes (Updated)
        # ═══════════════════════════════════════════════════════════════════

        - id: auth-service-register
          uri: lb://AUTH-SERVICE
          predicates:
            - Path=/api/auth/register
            - Method=POST
          filters:
            - name: CircuitBreaker
              args:
                name: authServiceCircuitBreaker
                fallbackUri: forward:/fallback/auth

        - id: auth-service-login
          uri: lb://AUTH-SERVICE
          predicates:
            - Path=/api/auth/login
            - Method=POST
          filters:
            - name: CircuitBreaker
              args:
                name: authServiceCircuitBreaker
                fallbackUri: forward:/fallback/auth

        - id: auth-service-refresh
          uri: lb://AUTH-SERVICE
          predicates:
            - Path=/api/auth/refresh
            - Method=POST

        - id: auth-service-logout
          uri: lb://AUTH-SERVICE
          predicates:
            - Path=/api/auth/logout
            - Method=POST

        - id: auth-service-password-reset
          uri: lb://AUTH-SERVICE
          predicates:
            - Path=/api/auth/password/**
          filters:
            - name: CircuitBreaker
              args:
                name: authServiceCircuitBreaker
                fallbackUri: forward:/fallback/auth

      # ═══════════════════════════════════════════════════════════════════
      # ✅ UPDATED: CORS Configuration (Add OAuth2 Callback URLs)
      # ═══════════════════════════════════════════════════════════════════
      globalcors:
        cors-configurations:
          '[/**]':
            allowedOrigins:
              - "http://localhost:3000"
              - "http://localhost:3001"
              - "http://localhost:19006"
              - "https://youthconnect.ug"
              - "https://www.youthconnect.ug"
              # ✅ OAuth2 callback URLs
              - "http://localhost:8083"  # Auth service direct access
            allowedMethods: [GET, POST, PUT, DELETE, PATCH, OPTIONS]
            allowedHeaders: "*"
            exposedHeaders:
              - "Authorization"
              - "X-Total-Count"
              - "X-User-Id"
              - "Content-Disposition"
              - "X-File-Name"
              - "X-File-Size"
            allowCredentials: true
            maxAge: 3600