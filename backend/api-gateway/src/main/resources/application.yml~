# =============================================================================
# Youth Connect Uganda - API Gateway Configuration
# Production-Ready Configuration with All Features
# =============================================================================

server:
  port: 8088
  shutdown: graceful
  error:
    include-message: ON_PARAM           # Show detailed error messages only when requested
    include-binding-errors: ON_PARAM    # Show validation errors only when requested

spring:
  application:
    name: api-gateway

  # ==========================================================================
  # CLOUD GATEWAY CONFIGURATION
  # ==========================================================================
  cloud:
    gateway:
      # Discovery Locator (Automatic route creation from Eureka)
      discovery:
        locator:
          enabled: true
          lower-case-service-id: true

      # Global CORS Configuration
      globalcors:
        cors-configurations:
          '[/**]':
            allowedOrigins:
              - "http://localhost:3000"      # React Dev Server
              - "http://localhost:3001"      # Mobile App Dev
              - "https://youthconnect.ug"    # Production Frontend
            allowedMethods:
              - GET
              - POST
              - PUT
              - DELETE
              - OPTIONS
              - PATCH
            allowedHeaders: "*"
            allowCredentials: true
            maxAge: 3600

      # Manual Route Definitions
      routes:
        # ====================================================================
        # AUTH SERVICE ROUTES (Strictest Rate Limiting)
        # ====================================================================
        - id: auth-service-register
          uri: lb://auth-service
          predicates:
            - Path=/api/auth/register
            - Method=POST
          filters:
            - name: CircuitBreaker
              args:
                name: authServiceCircuitBreaker
                fallbackUri: forward:/fallback/auth
            - name: Retry
              args:
                retries: 3
                statuses: BAD_GATEWAY,GATEWAY_TIMEOUT
                methods: POST
                backoff:
                  firstBackoff: 50ms
                  maxBackoff: 500ms

        - id: auth-service-login
          uri: lb://auth-service
          predicates:
            - Path=/api/auth/login
            - Method=POST
          filters:
            - name: CircuitBreaker
              args:
                name: authServiceCircuitBreaker
                fallbackUri: forward:/fallback/auth

        - id: auth-service-refresh
          uri: lb://auth-service
          predicates:
            - Path=/api/auth/refresh
            - Method=POST

        - id: auth-service-logout
          uri: lb://auth-service
          predicates:
            - Path=/api/auth/logout
            - Method=POST

        - id: auth-service-reset-password
          uri: lb://auth-service
          predicates:
            - Path=/api/auth/reset-password/**

        # ====================================================================
        # USER SERVICE ROUTES
        # ====================================================================
        - id: user-service
          uri: lb://user-service
          predicates:
            - Path=/api/users/**
          filters:
            - name: CircuitBreaker
              args:
                name: userServiceCircuitBreaker
                fallbackUri: forward:/fallback/users
            - StripPrefix=1

        # ====================================================================
        # OPPORTUNITY SERVICE ROUTES
        # ====================================================================
        - id: opportunity-service
          uri: lb://opportunity-service
          predicates:
            - Path=/api/opportunities/**, /api/applications/**
          filters:
            - name: CircuitBreaker
              args:
                name: opportunityServiceCircuitBreaker
                fallbackUri: forward:/fallback/opportunities
            - StripPrefix=1

        # ====================================================================
        # CONTENT SERVICE ROUTES
        # ====================================================================
        - id: content-service-learning
          uri: lb://content-service
          predicates:
            - Path=/api/learning/**
          filters:
            - name: CircuitBreaker
              args:
                name: contentServiceCircuitBreaker
            - StripPrefix=1

        - id: content-service-feed
          uri: lb://content-service
          predicates:
            - Path=/api/feed/**, /api/posts/**, /api/comments/**
          filters:
            - name: CircuitBreaker
              args:
                name: contentServiceCircuitBreaker
            - StripPrefix=1

        # ====================================================================
        # MENTOR SERVICE ROUTES
        # ====================================================================
        - id: mentor-service
          uri: lb://mentor-service
          predicates:
            - Path=/api/mentorship/**, /api/mentors/**
          filters:
            - name: CircuitBreaker
              args:
                name: mentorServiceCircuitBreaker
                fallbackUri: forward:/fallback/mentorship
            - StripPrefix=1

        # ====================================================================
        # USSD SERVICE ROUTES (Moderate Rate Limiting)
        # ====================================================================
        - id: ussd-service
          uri: lb://ussd-service
          predicates:
            - Path=/api/ussd/**
          filters:
            - name: CircuitBreaker
              args:
                name: ussdServiceCircuitBreaker
            - StripPrefix=1

        # ====================================================================
        # AI RECOMMENDATION SERVICE ROUTES
        # ====================================================================
        - id: ai-recommendation-service
          uri: lb://ai-recommendation-service
          predicates:
            - Path=/api/recommendations/**
          filters:
            - name: CircuitBreaker
              args:
                name: aiServiceCircuitBreaker
            - StripPrefix=1

        # ====================================================================
        # ANALYTICS SERVICE ROUTES
        # ====================================================================
        - id: analytics-service
          uri: lb://analytics-service
          predicates:
            - Path=/api/analytics/**, /api/reports/**
          filters:
            - name: CircuitBreaker
              args:
                name: analyticsServiceCircuitBreaker
            - StripPrefix=1

        # ====================================================================
        # NOTIFICATION SERVICE ROUTES
        # ====================================================================
        - id: notification-service
          uri: lb://notification-service
          predicates:
            - Path=/api/notifications/**
          filters:
            - name: CircuitBreaker
              args:
                name: notificationServiceCircuitBreaker
            - StripPrefix=1

        # ====================================================================
        # FILE MANAGEMENT SERVICE ROUTES
        # ====================================================================
        - id: file-management-service
          uri: lb://file-management-service
          predicates:
            - Path=/api/files/**
          filters:
            - name: CircuitBreaker
              args:
                name: fileServiceCircuitBreaker
            - StripPrefix=1

      # HTTP Client Configuration
      httpclient:
        connect-timeout: 5000
        response-timeout: 30s
        pool:
          type: elastic
          max-idle-time: 30s

# =============================================================================
# EUREKA CLIENT CONFIGURATION
# =============================================================================
eureka:
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka/
    register-with-eureka: true
    fetch-registry: true
    registry-fetch-interval-seconds: 5
  instance:
    prefer-ip-address: true
    instance-id: ${spring.application.name}:${random.value}
    lease-renewal-interval-in-seconds: 5
    lease-expiration-duration-in-seconds: 10

# =============================================================================
# RATE LIMITING CONFIGURATION
# =============================================================================
app:
  security:
    rate-limit:
      enabled: true
      requests-per-minute: 100
      burst-capacity: 150
      auth-requests-per-minute: 20
      ussd-requests-per-minute: 50

# =============================================================================
# RESILIENCE4J CIRCUIT BREAKER CONFIGURATION
# =============================================================================
resilience4j:
  circuitbreaker:
    configs:
      default:
        register-health-indicator: true
        sliding-window-size: 10
        minimum-number-of-calls: 5
        permitted-number-of-calls-in-half-open-state: 3
        automatic-transition-from-open-to-half-open-enabled: true
        wait-duration-in-open-state: 10s
        failure-rate-threshold: 50
        slow-call-rate-threshold: 50
        slow-call-duration-threshold: 3s
    instances:
      authServiceCircuitBreaker:
        base-config: default
      userServiceCircuitBreaker:
        base-config: default
      opportunityServiceCircuitBreaker:
        base-config: default
      contentServiceCircuitBreaker:
        base-config: default
      mentorServiceCircuitBreaker:
        base-config: default
      ussdServiceCircuitBreaker:
        base-config: default

  timelimiter:
    configs:
      default:
        timeout-duration: 3s

# =============================================================================
# ACTUATOR & MONITORING CONFIGURATION
# =============================================================================
management:
  endpoints:
    web:
      exposure:
        include: health,info,prometheus,metrics,gateway
  endpoint:
    health:
      show-details: always
    gateway:
      enabled: true
  metrics:
    export:
      prometheus:
        enabled: true
    tags:
      application: ${spring.application.name}

# =============================================================================
# LOGGING CONFIGURATION
# =============================================================================
logging:
  level:
    root: INFO
    com.youthconnect: DEBUG
    org.springframework.cloud.gateway: DEBUG
    org.springframework.web: DEBUG
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
  file:
    name: logs/api-gateway.log
    max-size: 10MB
    max-history: 30
