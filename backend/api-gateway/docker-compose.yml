# =============================================================================
# Entrepreneurship Booster Platform - Docker Compose Configuration
# Complete microservices setup with API Gateway
# =============================================================================
version: '3.8'

# =============================================================================
# NETWORKS
# Isolates microservices communication
# =============================================================================
networks:
  youthconnect-network:
    driver: bridge
    name: youthconnect-network

# =============================================================================
# VOLUMES
# Persistent storage for databases and logs
# =============================================================================
volumes:
  postgres-data:
    name: youthconnect-postgres-data
  mongodb-data:
    name: youthconnect-mongodb-data
  gateway-logs:
    name: youthconnect-gateway-logs

# =============================================================================
# SERVICES
# =============================================================================
services:

  # ---------------------------------------------------------------------------
  # Service Registry (Eureka Server)
  # Must start first - other services depend on it
  # ---------------------------------------------------------------------------
  service-registry:
    build: ./service-registry
    container_name: service-registry
    ports:
      - "8761:8761"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - EUREKA_USERNAME=admin
      - EUREKA_PASSWORD=${EUREKA_PASSWORD:-changeme}
    networks:
      - youthconnect-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8761/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # ---------------------------------------------------------------------------
  # PostgreSQL Database
  # Shared database for user, auth, and other services
  # ---------------------------------------------------------------------------
  postgres:
    image: postgres:15-alpine
    container_name: postgres-db
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_DB=youthconnect
      - POSTGRES_USER=youthconnect_user
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-secure_password_123}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - youthconnect-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U youthconnect_user"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ---------------------------------------------------------------------------
  # Auth Service
  # Handles authentication and JWT token generation
  # ---------------------------------------------------------------------------
  auth-service:
    build: ./auth-service
    container_name: auth-service
    ports:
      - "8081:8081"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - JWT_SECRET=${JWT_SECRET}
      - DATABASE_URL=jdbc:postgresql://postgres:5432/youthconnect
      - DATABASE_USERNAME=youthconnect_user
      - DATABASE_PASSWORD=${POSTGRES_PASSWORD:-secure_password_123}
      - EUREKA_HOST=service-registry
      - EUREKA_PORT=8761
      - EUREKA_USERNAME=admin
      - EUREKA_PASSWORD=${EUREKA_PASSWORD:-changeme}
    depends_on:
      postgres:
        condition: service_healthy
      service-registry:
        condition: service_healthy
    networks:
      - youthconnect-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/api/auth/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s

  # ---------------------------------------------------------------------------
  # User Service
  # Manages user profiles and data
  # ---------------------------------------------------------------------------
  user-service:
    build: ./user-service
    container_name: user-service
    ports:
      - "8082:8082"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - DATABASE_URL=jdbc:postgresql://postgres:5432/youthconnect
      - DATABASE_USERNAME=youthconnect_user
      - DATABASE_PASSWORD=${POSTGRES_PASSWORD:-secure_password_123}
      - EUREKA_HOST=service-registry
      - EUREKA_PORT=8761
      - EUREKA_USERNAME=admin
      - EUREKA_PASSWORD=${EUREKA_PASSWORD:-changeme}
    depends_on:
      postgres:
        condition: service_healthy
      service-registry:
        condition: service_healthy
    networks:
      - youthconnect-network

  # ---------------------------------------------------------------------------
  # File Management Service
  # Handles file uploads and storage
  # ---------------------------------------------------------------------------
  file-management-service:
    build: ./file-management-service
    container_name: file-service
    ports:
      - "8089:8089"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - EUREKA_HOST=service-registry
      - EUREKA_PORT=8761
      - EUREKA_USERNAME=admin
      - EUREKA_PASSWORD=${EUREKA_PASSWORD:-changeme}
      - UPLOAD_DIR=/app/uploads
    volumes:
      - ./uploads:/app/uploads
    depends_on:
      service-registry:
        condition: service_healthy
    networks:
      - youthconnect-network

  # ---------------------------------------------------------------------------
  # API Gateway
  # Single entry point for all client requests
  # MUST START AFTER: service-registry, auth-service
  # ---------------------------------------------------------------------------
  api-gateway:
    build: ./api-gateway
    container_name: api-gateway
    ports:
      - "8088:8088"
    environment:
      # Application Settings
      - SPRING_PROFILES_ACTIVE=docker
      - SERVER_PORT=8088

      # JWT Configuration (MUST match auth-service)
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRATION=86400000

      # Eureka Configuration
      - EUREKA_HOST=service-registry
      - EUREKA_PORT=8761
      - EUREKA_USERNAME=admin
      - EUREKA_PASSWORD=${EUREKA_PASSWORD:-changeme}

      # CORS Configuration
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-http://localhost:3000,http://localhost:3001}
      - CORS_ALLOWED_METHODS=GET,POST,PUT,DELETE,OPTIONS,PATCH

      # Rate Limiting
      - RATE_LIMIT_ENABLED=true
      - RATE_LIMIT_REQUESTS_PER_MINUTE=100
      - RATE_LIMIT_AUTH_REQUESTS_PER_MINUTE=20

      # Circuit Breaker
      - CIRCUIT_BREAKER_FAILURE_RATE_THRESHOLD=50
      - CIRCUIT_BREAKER_WAIT_DURATION=10s

      # Timeouts
      - GATEWAY_CONNECT_TIMEOUT=10000
      - GATEWAY_RESPONSE_TIMEOUT=120s

      # File Upload
      - SPRING_SERVLET_MULTIPART_MAX_FILE_SIZE=50MB
      - SPRING_SERVLET_MULTIPART_MAX_REQUEST_SIZE=100MB

      # Logging
      - LOGGING_LEVEL_GATEWAY=DEBUG
      - LOGGING_LEVEL_ROOT=INFO
    volumes:
      - gateway-logs:/app/logs
    depends_on:
      service-registry:
        condition: service_healthy
      auth-service:
        condition: service_healthy
    networks:
      - youthconnect-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8088/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s

# =============================================================================
# USAGE INSTRUCTIONS
# =============================================================================
#
# 1. Create .env file with required secrets:
#    cp .env.example .env
#    # Edit .env and set JWT_SECRET, passwords, etc.
#
# 2. Start all services:
#    docker-compose up -d
#
# 3. Check service health:
#    docker-compose ps
#
# 4. View logs:
#    docker-compose logs -f api-gateway
#    docker-compose logs -f auth-service
#
# 5. Stop all services:
#    docker-compose down
#
# 6. Stop and remove volumes (WARNING: deletes data):
#    docker-compose down -v
#
# 7. Rebuild specific service:
#    docker-compose build api-gateway
#    docker-compose up -d api-gateway
#
# 8. Scale a service:
#    docker-compose up -d --scale user-service=3
#
# =============================================================================
# STARTUP ORDER
# =============================================================================
#
# 1. service-registry (Eureka) - Port 8761
# 2. postgres - Port 5432
# 3. auth-service - Port 8081 (depends on postgres + eureka)
# 4. user-service - Port 8082 (depends on postgres + eureka)
# 5. file-management-service - Port 8089 (depends on eureka)
# 6. api-gateway - Port 8088 (depends on eureka + auth-service)
#
# Total startup time: ~2-3 minutes
#
# =============================================================================
# HEALTH CHECK ENDPOINTS
# =============================================================================
#
# Service Registry: http://localhost:8761/actuator/health
# Auth Service:     http://localhost:8081/api/auth/health
# User Service:     http://localhost:8082/api/v1/users/health
# File Service:     http://localhost:8089/api/files/health
# API Gateway:      http://localhost:8088/health
#
# =============================================================================