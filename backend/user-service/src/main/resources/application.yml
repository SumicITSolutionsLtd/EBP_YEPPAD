# ═════════════════════════════════════════════════════════════════════════════
# USER SERVICE - SPRING BOOT CONFIGURATION
# ═════════════════════════════════════════════════════════════════════════════
# Version: 6.0.1 (Merged Eureka Fix + Swagger + Docker)
# Date: 2025-11-29
# Description: Configuration for User Management, Authentication integration,
#              Service Discovery, and API Documentation.
# ═════════════════════════════════════════════════════════════════════════════

spring:
  application:
    name: user-service

  # ───────────────────────────────────────────────────────────────────────────
  # POSTGRESQL DATABASE CONFIGURATION
  # ───────────────────────────────────────────────────────────────────────────
  datasource:
    # JDBC URL with timeouts and keep-alive settings to prevent stale connections
    url: jdbc:postgresql://${DB_HOST:localhost}:${DB_PORT:5432}/${DB_NAME:youthconnect_user}?currentSchema=public&connectTimeout=120&socketTimeout=180&tcpKeepAlive=true&loginTimeout=60
    username: ${DB_USER:youthconnect_user}
    password: ${DB_PASSWORD:YouthConnect2024!}
    driver-class-name: org.postgresql.Driver

    # HikariCP Connection Pool Tuning
    hikari:
      maximum-pool-size: ${DB_MAX_POOL_SIZE:20}
      minimum-idle: ${DB_MIN_IDLE:5}
      connection-timeout: 120000 # 2 minutes
      idle-timeout: 600000       # 10 minutes
      max-lifetime: 1800000      # 30 minutes
      pool-name: YouthConnectUserServicePool
      connection-test-query: SELECT 1
      validation-timeout: 10000
      auto-commit: true
      leak-detection-threshold: 120000

  # ───────────────────────────────────────────────────────────────────────────
  # JPA/HIBERNATE CONFIGURATION
  # ───────────────────────────────────────────────────────────────────────────
  jpa:
    database: POSTGRESQL
    database-platform: org.hibernate.dialect.PostgreSQLDialect

    # CRITICAL: Disable Open-In-View to prevent DB connection holding during view rendering
    open-in-view: false

    hibernate:
      # 'validate' checks schema against entities but does not alter DB
      ddl-auto: ${SPRING_JPA_HIBERNATE_DDL_AUTO:validate}
      naming:
        physical-strategy: org.hibernate.boot.model.naming.PhysicalNamingStrategyStandardImpl

    show-sql: ${SPRING_JPA_SHOW_SQL:false}
    properties:
      hibernate:
        format_sql: false
        jdbc:
          batch_size: 20
          fetch_size: 50
        order_inserts: true
        order_updates: true
        query:
          timeout: 120000

  # ───────────────────────────────────────────────────────────────────────────
  # FLYWAY DATABASE MIGRATION
  # ───────────────────────────────────────────────────────────────────────────
  flyway:
    enabled: true
    baseline-on-migrate: true
    baseline-version: 0
    validate-on-migrate: true
    out-of-order: false
    locations: classpath:db/migration
    schemas: public
    connect-retries: 5

# ═════════════════════════════════════════════════════════════════════════════
# APPLICATION SECURITY & LIMITS
# ═════════════════════════════════════════════════════════════════════════════
app:
  security:
    internal-api-key: ${INTERNAL_API_KEY:dev-internal-api-key-change-in-production-2024}
    jwt:
      enabled: false # Auth verification handled via API Gateway or Auth Service
    rate-limit:
      enabled: ${RATE_LIMIT_ENABLED:false}
      requests-per-minute: ${RATE_LIMIT_REQUESTS_PER_MINUTE:100}

# ═════════════════════════════════════════════════════════════════════════════
# SERVER CONFIGURATION
# ═════════════════════════════════════════════════════════════════════════════
server:
  port: ${USER_SERVICE_PORT:${SERVER_PORT:8181}}
  tomcat:
    connection-timeout: 120000
    keep-alive-timeout: 120000

# ═════════════════════════════════════════════════════════════════════════════
# EUREKA SERVICE DISCOVERY (CRITICAL FIX APPLIED)
# ═════════════════════════════════════════════════════════════════════════════
eureka:
  client:
    enabled: ${EUREKA_ENABLED:true}

    # ✅ FIX: Force RestTemplate to prevent Jersey "UnknownContentTypeException" crash
    release-jersey-client: true

    service-url:
      defaultZone: http://${EUREKA_USERNAME:admin}:${EUREKA_PASSWORD:changeme}@${EUREKA_HOST:localhost}:${EUREKA_PORT:8761}/eureka/

    register-with-eureka: true
    fetch-registry: true
    registry-fetch-interval-seconds: 30
    healthcheck:
      enabled: true

  instance:
    prefer-ip-address: true
    instance-id: ${spring.application.name}:${server.port}
    lease-renewal-interval-in-seconds: 30
    lease-expiration-duration-in-seconds: 90
    metadata-map:
      zone: default
      version: 1.0.0
      management.context-path: ${management.endpoints.web.base-path:/actuator}

  encoder:
    type: jackson

# ═════════════════════════════════════════════════════════════════════════════
# SPRING CLOUD CONFIGURATION
# ═════════════════════════════════════════════════════════════════════════════
spring.cloud:
  loadbalancer:
    ribbon:
      enabled: false
    cache:
      enabled: true
      ttl: 35s
  discovery:
    enabled: true

# ═════════════════════════════════════════════════════════════════════════════
# SPRINGDOC OPENAPI / SWAGGER CONFIGURATION
# ═════════════════════════════════════════════════════════════════════════════
# Access UI: http://localhost:8181/swagger-ui.html
# Access JSON: http://localhost:8181/v3/api-docs
# ═════════════════════════════════════════════════════════════════════════════
springdoc:
  api-docs:
    enabled: true
    path: /v3/api-docs
  swagger-ui:
    enabled: true
    path: /swagger-ui.html
    operations-sorter: method
    tags-sorter: alpha
    display-request-duration: true
    doc-expansion: none
    try-it-out-enabled: true
    persist-authorization: true

  show-actuator: false
  default-consumes-media-type: application/json
  default-produces-media-type: application/json
  path-matching-strategy: ant-path-matcher

# ═════════════════════════════════════════════════════════════════════════════
# LOGGING CONFIGURATION
# ═════════════════════════════════════════════════════════════════════════════
logging:
  level:
    root: INFO
    com.youthconnect.user_service: DEBUG
    org.hibernate.SQL: ${SPRING_JPA_SHOW_SQL:false}
    org.springframework.security: DEBUG
    org.flywaydb: INFO
    com.zaxxer.hikari: DEBUG
    com.netflix.discovery: INFO
    com.netflix.eureka: INFO
    org.springdoc: INFO
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{50} - %msg%n"

# ═════════════════════════════════════════════════════════════════════════════
# PROFILE: DEVELOPMENT (active when spring_profiles_active=dev)
# ═════════════════════════════════════════════════════════════════════════════
---
spring:
  config:
    activate:
      on-profile: dev

  jpa:
    hibernate:
      ddl-auto: update # Allow hibernate to update schema in dev
    show-sql: true

app:
  security:
    internal-api-key: dev-internal-api-key-2024

eureka:
  client:
    service-url:
      defaultZone: http://admin:changeme@localhost:8761/eureka/

logging:
  level:
    org.hibernate.SQL: DEBUG
    org.springdoc: DEBUG

# ═════════════════════════════════════════════════════════════════════════════
# PROFILE: DOCKER (active when spring_profiles_active=docker)
# ═════════════════════════════════════════════════════════════════════════════
---
spring:
  config:
    activate:
      on-profile: docker

  datasource:
    # Uses container name 'postgres-db'
    url: jdbc:postgresql://postgres-db:5432/youthconnect_user?currentSchema=public&connectTimeout=120&socketTimeout=180&tcpKeepAlive=true&loginTimeout=60

app:
  security:
    internal-api-key: ${INTERNAL_API_KEY:docker-internal-api-key-2024}

eureka:
  client:
    service-url:
      # Uses container name 'service-registry'
      defaultZone: http://${EUREKA_USERNAME:admin}:${EUREKA_PASSWORD:changeme}@service-registry:8761/eureka/

  instance:
    prefer-ip-address: true
    # hostname: user-service # rely on IP in docker network usually safer

# ═════════════════════════════════════════════════════════════════════════════
# PROFILE: PRODUCTION (active when spring_profiles_active=prod)
# ═════════════════════════════════════════════════════════════════════════════
---
spring:
  config:
    activate:
      on-profile: prod

  jpa:
    hibernate:
      ddl-auto: validate # Strict validation only
    show-sql: false

  datasource:
    hikari:
      maximum-pool-size: 50
      minimum-idle: 10

app:
  security:
    internal-api-key: ${INTERNAL_API_KEY} # Must be set in env vars

eureka:
  client:
    service-url:
      defaultZone: http://${EUREKA_USERNAME}:${EUREKA_PASSWORD}@${EUREKA_HOST}:${EUREKA_PORT:8761}/eureka/

logging:
  level:
    root: WARN
    com.youthconnect.user_service: INFO
    org.springdoc: WARN