# ═════════════════════════════════════════════════════════════════════════════
# USER SERVICE - POSTGRESQL CONFIGURATION (ENHANCED v2.1)
# ═════════════════════════════════════════════════════════════════════════════
# ✅ FIXES APPLIED:
# 1. Increased connection timeouts (30s → 2 min for migrations)
# 2. Increased Flyway retry settings (3 → 5 retries)
# 3. Enhanced connection pool configuration
# 4. Improved timeout handling for schema validation
# ═════════════════════════════════════════════════════════════════════════════

spring:
  application:
    name: user-service

  # ---------------------------------------------------------------------------
  # PostgreSQL Database Configuration
  # ---------------------------------------------------------------------------
  datasource:
    # ✅ FIXED: Increased timeouts for Flyway migrations
    # - connectTimeout: 30s → 120s (2 minutes)
    # - socketTimeout: 120s → 180s (3 minutes)
    # - loginTimeout: 30s → 60s (1 minute)
    url: jdbc:postgresql://${DB_HOST:localhost}:${DB_PORT:5432}/${DB_NAME:youthconnect_user}?currentSchema=public&connectTimeout=120&socketTimeout=180&tcpKeepAlive=true&loginTimeout=60

    username: ${DB_USER:youthconnect_user}
    password: ${DB_PASSWORD:YouthConnect2024!}
    driver-class-name: org.postgresql.Driver

    hikari:
      maximum-pool-size: ${DB_MAX_POOL_SIZE:20}
      minimum-idle: ${DB_MIN_IDLE:5}

      # ✅ FIXED: Increased connection timeout for migrations
      connection-timeout: 120000  # 2 minutes (was 30 seconds)

      idle-timeout: 600000
      max-lifetime: 1800000
      pool-name: YouthConnectUserServicePool
      connection-test-query: SELECT 1
      auto-commit: true

      # ✅ FIXED: Increased leak detection threshold
      leak-detection-threshold: 120000  # 2 minutes (was 1 minute)

      validation-timeout: 10000  # 10 seconds

  # ---------------------------------------------------------------------------
  # JPA/Hibernate Configuration
  # ---------------------------------------------------------------------------
  jpa:
    database: POSTGRESQL
    database-platform: org.hibernate.dialect.PostgreSQLDialect
    hibernate:
      ddl-auto: ${SPRING_JPA_HIBERNATE_DDL_AUTO:validate}
      naming:
        physical-strategy: org.hibernate.boot.model.naming.PhysicalNamingStrategyStandardImpl

    show-sql: ${SPRING_JPA_SHOW_SQL:false}

    properties:
      hibernate:
        format_sql: false
        jdbc:
          batch_size: 20
          fetch_size: 50
        order_inserts: true
        order_updates: true
        query:
          # ✅ FIXED: Increased query timeout for complex operations
          timeout: 120000  # 2 minutes

  # ---------------------------------------------------------------------------
  # Flyway Database Migrations Configuration
  # ---------------------------------------------------------------------------
  flyway:
    enabled: true
    baseline-on-migrate: true
    validate-on-migrate: true
    locations: classpath:db/migration
    schemas: public
    baseline-version: 0

    # ✅ FIXED: Enhanced retry configuration
    connect-retries: 5  # Increased from 3
    lock-retry-count: 100  # Increased from 50
    connect-retries-interval: 10  # 10 seconds between retries

    out-of-order: false
    placeholder-replacement: false

# ═════════════════════════════════════════════════════════════════════════════
# SERVER CONFIGURATION
# ═════════════════════════════════════════════════════════════════════════════

server:
  port: ${SERVER_PORT:8081}
  tomcat:
    # ✅ FIXED: Increased Tomcat timeouts
    connection-timeout: 120000  # 2 minutes
    keep-alive-timeout: 120000  # 2 minutes

# ═════════════════════════════════════════════════════════════════════════════
# EUREKA SERVICE DISCOVERY
# ═════════════════════════════════════════════════════════════════════════════

eureka:
  client:
    enabled: ${EUREKA_ENABLED:true}
    service-url:
      defaultZone: ${EUREKA_URL:http://localhost:8761/eureka/}
    register-with-eureka: true
    fetch-registry: true
    registry-fetch-interval-seconds: 30

  instance:
    prefer-ip-address: true
    instance-id: ${spring.application.name}:${server.port}
    lease-renewal-interval-in-seconds: 30
    lease-expiration-duration-in-seconds: 90
    metadata-map:
      zone: default

# ═════════════════════════════════════════════════════════════════════════════
# LOGGING CONFIGURATION
# ═════════════════════════════════════════════════════════════════════════════

logging:
  level:
    root: INFO
    com.youthconnect.user_service: DEBUG
    org.hibernate.SQL: ${SPRING_JPA_SHOW_SQL:false}
    org.springframework.security: DEBUG
    org.flywaydb: INFO
    com.zaxxer.hikari: DEBUG

# ═════════════════════════════════════════════════════════════════════════════
# DEVELOPMENT PROFILE
# ═════════════════════════════════════════════════════════════════════════════

---
spring:
  config:
    activate:
      on-profile: dev

  jpa:
    hibernate:
      ddl-auto: update
    show-sql: true

logging:
  level:
    root: INFO
    com.youthconnect.user_service: DEBUG
    org.hibernate.SQL: DEBUG
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE
    org.flywaydb: DEBUG

# ═════════════════════════════════════════════════════════════════════════════
# DOCKER PROFILE
# ═════════════════════════════════════════════════════════════════════════════

---
spring:
  config:
    activate:
      on-profile: docker

  datasource:
    url: jdbc:postgresql://postgres-db:5432/youthconnect_user?currentSchema=public&connectTimeout=120&socketTimeout=180&tcpKeepAlive=true&loginTimeout=60

eureka:
  client:
    service-url:
      defaultZone: http://eureka-server:8761/eureka/
  instance:
    prefer-ip-address: false
    hostname: user-service

# ═════════════════════════════════════════════════════════════════════════════
# PRODUCTION PROFILE
# ═════════════════════════════════════════════════════════════════════════════

---
spring:
  config:
    activate:
      on-profile: prod

  jpa:
    hibernate:
      ddl-auto: validate
    show-sql: false

  datasource:
    hikari:
      maximum-pool-size: 50
      minimum-idle: 10
      connection-timeout: 120000
      leak-detection-threshold: 60000

logging:
  level:
    root: WARN
    com.youthconnect.user_service: INFO
    org.hibernate.SQL: false
    org.flywaydb: INFO

eureka:
  instance:
    lease-renewal-interval-in-seconds: 10
    lease-expiration-duration-in-seconds: 30