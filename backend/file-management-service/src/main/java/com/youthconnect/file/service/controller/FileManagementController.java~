package com.youthconnect.file.service.controller;

import com.youthconnect.file.service.dto.FileUploadResult;
import com.youthconnect.file.service.service.FileManagementService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.core.io.Resource;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import java.util.Map;
import java.util.concurrent.CompletableFuture;

/**
 * REST Controller for file management operations
 *
 * Endpoints:
 * - POST /api/files/profile-picture/{userId} - Upload profile picture
 * - POST /api/files/audio-module - Upload audio learning module
 * - POST /api/files/document/{userId} - Upload user document
 * - GET /api/files/audio-module/{moduleKey} - Get module audio files
 * - GET /api/files/download/{category}/{fileName} - Download file
 * - DELETE /api/files/{userId}/{fileName} - Delete file
 * - GET /api/files/metadata/{category}/{fileName} - Get file metadata
 * - GET /api/files/health - Health check
 *
 * @author Douglas Kings Kato
 * @version 1.0.0
 */
@Slf4j
@RestController
@RequestMapping("/api/files")
@RequiredArgsConstructor
public class FileManagementController {

    private final FileManagementService fileService;

    /**
     * Upload profile picture for a user
     *
     * @param userId User ID
     * @param file Profile picture file
     * @return Upload result with file URLs
     */
    @PostMapping("/profile-picture/{userId}")
    public CompletableFuture<ResponseEntity<Map<String, Object>>> uploadProfilePicture(
            @PathVariable Long userId,
            @RequestParam("file") MultipartFile file) {

        log.info("Profile picture upload request for user: {}", userId);

        return fileService.uploadProfilePicture(userId, file)
                .thenApply(result -> {
                    if (result.isSuccess()) {
                        return ResponseEntity.ok(Map.of(
                                "success", true,
                                "message", "Profile picture uploaded successfully",
                                "fileName", result.getFileName(),
                                "fileUrl", result.getFileUrl(),
                                "optimizedVersions", result.getOptimizedVersions()
                        ));
                    } else {
                        return ResponseEntity.badRequest().body(Map.of(
                                "success", false,
                                "error", "Failed to upload profile picture",
                                "message", result.getErrorMessage()
                        ));
                    }
                });
    }

    /**
     * Upload audio file for learning modules
     *
     * @param moduleKey Module identifier
     * @param language Language code (en, lg, lur, lgb)
     * @param file Audio file
     * @return Upload result with file URLs
     */
    @PostMapping("/audio-module")
    public CompletableFuture<ResponseEntity<Map<String, Object>>> uploadAudioModule(
            @RequestParam("moduleKey") String moduleKey,
            @RequestParam("language") String language,
            @RequestParam("file") MultipartFile file) {

        log.info("Audio module upload request - Module: {}, Language: {}", moduleKey, language);

        return fileService.uploadAudioModule(moduleKey, language, file)
                .thenApply(result -> {
                    if (result.isSuccess()) {
                        return ResponseEntity.ok(Map.of(
                                "success", true,
                                "message", "Audio module uploaded successfully",
                                "fileName", result.getFileName(),
                                "fileUrl", result.getFileUrl(),
                                "processedVersions", result.getProcessedVersions()
                        ));
                    } else {
                        return ResponseEntity.badRequest().body(Map.of(
                                "success", false,
                                "error", "Failed to upload audio module",
                                "message", result.getErrorMessage()
                        ));
                    }
                });
    }

    /**
     * Upload document for user (CV, certificates, etc.)
     *
     * @param userId User ID
     * @param documentType Type of document (CV, CERTIFICATE, etc.)
     * @param file Document file
     * @return Upload result
     */
    @PostMapping("/document/{userId}")
    public CompletableFuture<ResponseEntity<Map<String, Object>>> uploadDocument(
            @PathVariable Long userId,
            @RequestParam("documentType") String documentType,
            @RequestParam("file") MultipartFile file) {

        log.info("Document upload request - User: {}, Type: {}", userId, documentType);

        return fileService.uploadUserDocument(userId, documentType, file)
                .thenApply(result -> {
                    if (result.isSuccess()) {
                        return ResponseEntity.ok(Map.of(
                                "success", true,
                                "message", "Document uploaded successfully",
                                "fileName", result.getFileName(),
                                "fileUrl", result.getFileUrl(),
                                "documentType", result.getDocumentType()
                        ));
                    } else {
                        return ResponseEntity.badRequest().body(Map.of(
                                "success", false,
                                "error", "Failed to upload document",
                                "message", result.getErrorMessage()
                        ));
                    }
                });
    }

    /**
     * Get audio files for a learning module in all languages
     *
     * @param moduleKey Module identifier
     * @return Map of language codes to audio file URLs
     */
    @GetMapping("/audio-module/{moduleKey}")
    public ResponseEntity<Map<String, Object>> getModuleAudioFiles(@PathVariable String moduleKey) {
        log.info("Retrieving audio files for module: {}", moduleKey);

        Map<String, String> audioFiles = fileService.getModuleAudioFiles(moduleKey);

        return ResponseEntity.ok(Map.of(
                "success", true,
                "moduleKey", moduleKey,
                "audioFiles", audioFiles,
                "count", audioFiles.size()
        ));
    }

    /**
     * Download/serve file
     *
     * @param category File category (users, modules, etc.)
     * @param fileName File name
     * @param userId User ID (required for user files)
     * @return File resource
     */
    @GetMapping("/download/{category}/{fileName}")
    public ResponseEntity<Resource> downloadFile(
            @PathVariable String category,
            @PathVariable String fileName,
            @RequestParam(required = false) Long userId) {

        try {
            Resource file = fileService.loadFileAsResource(category, fileName, userId);
            String contentType = fileService.getContentType(fileName);

            return ResponseEntity.ok()
                    .contentType(MediaType.parseMediaType(contentType))
                    .header(HttpHeaders.CONTENT_DISPOSITION,
                            "attachment; filename=\"" + fileName + "\"")
                    .body(file);

        } catch (Exception e) {
            log.error("Error downloading file {}/{}: {}", category, fileName, e.getMessage());
            return ResponseEntity.notFound().build();
        }
    }

    /**
     * Delete user file
     *
     * @param userId User ID
     * @param fileName File name
     * @param category File category
     * @return Success status
     */
    @DeleteMapping("/{userId}/{fileName}")
    public CompletableFuture<ResponseEntity<Map<String, Object>>> deleteFile(
            @PathVariable Long userId,
            @PathVariable String fileName,
            @RequestParam String category) {

        log.log.info("Delete file request - User: {}, File: {}, Category: {}", userId, fileName, category);

        return fileService.deleteUserFile(userId, fileName, category)
                .thenApply(success -> {
                    if (success) {
                        return ResponseEntity.ok(Map.of(
                                "success", true,
                                "message", "File deleted successfully",
                                "fileName", fileName
                        ));
                    } else {
                        return ResponseEntity.badRequest().body(Map.of(
                                "success", false,
                                "error", "Failed to delete file",
                                "fileName", fileName
                        ));
                    }
                });
    }

    /**
     * Get file metadata
     *
     * @param category File category
     * @param fileName File name
     * @param userId User ID (optional)
     * @return File metadata
     */
    @GetMapping("/metadata/{category}/{fileName}")
    public ResponseEntity<Map<String, Object>> getFileMetadata(
            @PathVariable String category,
            @PathVariable String fileName,
            @RequestParam(required = false) Long userId) {

        try {
            var metadata = fileService.getFileMetadata(category, fileName, userId);

            if (metadata != null) {
                return ResponseEntity.ok(Map.of(
                        "success", true,
                        "metadata", metadata
                ));
            } else {
                return ResponseEntity.notFound().build();
            }

        } catch (Exception e) {
            log.error("Error getting file metadata: {}", e.getMessage());
            return ResponseEntity.badRequest().body(Map.of(
                    "success", false,
                    "error", "Failed to get file metadata"
            ));
        }
    }

    /**
     * Health check endpoint
     *
     * @return Service health status
     */
    @GetMapping("/health")
    public ResponseEntity<Map<String, Object>> healthCheck() {
        boolean storageHealthy = fileService.checkStorageHealth();

        return ResponseEntity.ok(Map.of(
                "status", "UP",
                "service", "file-management-service",
                "checks", Map.of(
                        "storage", storageHealthy ? "UP" : "DOWN"
                )
        ));
    }
}