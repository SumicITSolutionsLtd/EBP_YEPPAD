# ═══════════════════════════════════════════════════════════════════════════
# Docker Compose - File Service Addition
# ═══════════════════════════════════════════════════════════════════════════
# Add this to your existing docker-compose.yml file

services:
  # ... (keep existing services: postgres, eureka, api-gateway, etc.)

  # ============================================================
  # FILE MANAGEMENT SERVICE
  # Handles file uploads, downloads, and storage
  # ============================================================
  file-management-service:
    build:
      context: ./file-management-service
      dockerfile: Dockerfile
    container_name: file-management-service

    # Service will restart automatically if it crashes
    restart: unless-stopped

    ports:
      - "8089:8089"

    # Environment variables
    environment:
      # Database Configuration
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: epb_file
      DB_USER: epb_app_user
      DB_PASSWORD: ${DB_PASSWORD:-ReplaceWithStrongAppUserPassword2025!}

      # Eureka Configuration (with authentication)
      EUREKA_USERNAME: ${EUREKA_USERNAME:-admin}
      EUREKA_PASSWORD: ${EUREKA_PASSWORD:-changeme}
      EUREKA_HOST: service-registry
      EUREKA_PORT: 8761

      # Storage Configuration
      STORAGE_TYPE: LOCAL
      STORAGE_PATH: /app/uploads/
      BASE_URL: http://localhost:8089

      # Java Options
      JAVA_OPTS: >-
        -Xms512m
        -Xmx1024m
        -Dspring.profiles.active=prod

    # Volumes for persistent storage
    volumes:
      # File uploads storage (persistent)
      - file-storage:/app/uploads
      # Logs (optional, for debugging)
      - ./logs/file-service:/app/logs

    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8089/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    # Service dependencies
    depends_on:
      postgres:
        condition: service_healthy
      service-registry:
        condition: service_healthy

    # Network
    networks:
      - epb-network

    # Resource limits (optional)
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

# ============================================================
# VOLUMES
# ============================================================
volumes:
  # Persistent volume for file uploads
  file-storage:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data/uploads  # Local directory for file storage

# ============================================================
# NETWORKS
# ============================================================
networks:
  epb-network:
    driver: bridge

# ═══════════════════════════════════════════════════════════════════════════
# USAGE INSTRUCTIONS
# ═══════════════════════════════════════════════════════════════════════════
#
# 1. Create uploads directory:
#    mkdir -p ./data/uploads
#
# 2. Start all services:
#    docker-compose up -d
#
# 3. Check service status:
#    docker-compose ps
#
# 4. View logs:
#    docker-compose logs -f file-management-service
#
# 5. Stop services:
#    docker-compose down
#
# 6. Stop and remove volumes:
#    docker-compose down -v
#
# ═══════════════════════════════════════════════════════════════════════════